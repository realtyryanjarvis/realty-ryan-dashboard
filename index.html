<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase handles live updates now -->
<title>Transaction Dashboard ‚Äî Realty Ryan</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #1a1408; font-family: 'Work Sans', sans-serif; color: #FAFAFA; min-height: 100vh; }

/* Password Gate */
#login-gate { display: none; }
#dashboard { display: block; }
.login-box { background: #261A05; padding: 48px; border-radius: 12px; border: 1px solid #5C3D14; width: 100%; max-width: 380px; text-align: center; }
.login-box h1 { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 8px; }
.login-box .sub { font-size: 13px; color: #857D52; margin-bottom: 32px; }
.login-box input { width: 100%; padding: 14px 16px; background: #1a1408; border: 1px solid #5C3D14; border-radius: 6px; color: #FAFAFA; font-family: 'Work Sans', sans-serif; font-size: 14px; margin-bottom: 16px; outline: none; }
.login-box input:focus { border-color: #7A3B14; }
.login-box button { width: 100%; padding: 14px; background: #7A3B14; color: #FAFAFA; border: none; border-radius: 6px; font-family: 'Work Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em; }
.login-box button:hover { background: #9A4B1A; }
.login-error { color: #ff887c; font-size: 12px; margin-bottom: 12px; display: none; }

/* Header */
.header-compact { background: #261A05; border-bottom: 2px solid #7A3B14; }
.hdr-top { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px 10px; }
.hdr-top h1 { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 300; letter-spacing: 0.12em; text-transform: uppercase; color: #FAFAFA; margin: 0; }
.hdr-actions { display: flex; gap: 6px; }
.btn-action { padding: 6px 12px; background: #7A3B14; color: #FAFAFA; border-radius: 4px; font-size: 11px; font-weight: 600; text-decoration: none; text-transform: uppercase; letter-spacing: 0.05em; }
.btn-action:hover { background: #9A4B1A; text-decoration: none; }
.btn-offer { background: #c97a3b !important; }
.btn-offer:hover { background: #e08a42 !important; }
.btn-green { background: #2a5a3a; }
.btn-green:hover { background: #3a7a4a; }
.btn-purple { background: #3a2a5a; }
.btn-purple:hover { background: #4a3a7a; }
.hdr-numbers { display: flex; justify-content: center; align-items: center; gap: 0; padding: 8px 24px 14px; }
.hn { text-align: center; padding: 0 24px; }
.hn-num { font-family: 'Cormorant Garamond', serif; font-size: 36px; font-weight: 600; color: #FAFAFA; display: block; line-height: 1; }
.hn-lbl { font-size: 10px; color: #857D52; text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; display: block; }
.hn.vol .hn-num { color: #7A3B14; }
.hn-divider { width: 1px; height: 36px; background: #3a2a10; }
.section-label { padding: 10px 24px 4px; font-family: 'Work Sans', sans-serif; font-size: 13px; font-weight: 600; color: #857D52; text-transform: uppercase; letter-spacing: 0.1em; }
.sl-count { color: #5C3D14; font-weight: 400; }
.new-listing-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; background: #7A3B14; color: #FAFAFA; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; transition: background 0.2s; }
.new-listing-btn:hover { background: #9A4B1A; }
/* Bottom Section */
.bottom-section { display: flex; gap: 20px; padding: 12px 24px 16px; }
.bottom-left { flex: 2; min-width: 0; }
.bottom-right { flex: 1; min-width: 260px; max-width: 340px; }
.stat { text-align: center; }
.stat-num { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 600; color: #7A3B14; }
.stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #857D52; }

/* Section Headers */
.section-header { padding: 16px 24px 8px; display: flex; align-items: center; gap: 12px; }
.section-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 600; color: #FAFAFA; letter-spacing: 0.08em; }
.section-badge { background: #7A3B14; color: #FAFAFA; font-size: 11px; font-weight: 600; padding: 2px 10px; border-radius: 12px; }

/* Kanban Board */
.kanban { display: flex; gap: 12px; padding: 12px 24px 24px; overflow-x: auto; min-height: 200px; -webkit-overflow-scrolling: touch; }
.kanban-col { flex: 0 0 240px; background: #261A05; border-radius: 8px; overflow: hidden; }
.kanban-col-header { padding: 12px 14px 8px; border-bottom: 2px solid; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; display: flex; justify-content: space-between; align-items: center; }
.kanban-col-header .count { background: rgba(255,255,255,0.1); padding: 1px 8px; border-radius: 10px; font-size: 11px; }
.kanban-cards { padding: 8px; display: flex; flex-direction: column; gap: 8px; }

/* Cards */
.card { background: #1a1408; border-radius: 6px; padding: 12px; border-left: 3px solid; cursor: pointer; transition: transform 0.15s; display: block; }
.card:hover { transform: translateY(-1px); }
.card-address { font-weight: 600; font-size: 13px; color: #FAFAFA; margin-bottom: 3px; }
.card-sublabel { font-size: 10px; font-weight: 600; color: #7A3B14; text-transform: uppercase; letter-spacing: 1px; padding: 4px 0 6px; border-bottom: 1px solid #3a2a10; margin-bottom: 6px; }
.card-client { font-size: 11px; color: #857D52; margin-bottom: 4px; }
.card-price { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 600; color: #7A3B14; }
.card-note { font-size: 10px; color: #857D52; margin-top: 4px; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 220px; }
.card-meta { display: flex; justify-content: space-between; margin-top: 6px; font-size: 10px; color: #857D52; }

/* Column Colors */
.col-leads .kanban-col-header { border-color: #ff9f6b; color: #ff9f6b; }
.col-hot .kanban-col-header { border-color: #ff4444; color: #ff4444; }
.col-hot .card { border-left-color: #ff4444; }
.col-contingent .kanban-col-header { border-color: #a67c52; color: #a67c52; }
.col-contingent .card { border-left-color: #a67c52; }
.col-leads .card { border-left-color: #ff9f6b; }
.col-prep .kanban-col-header { border-color: #dbadff; color: #dbadff; }
.col-prep .card { border-left-color: #dbadff; }
.col-live .kanban-col-header { border-color: #46d67a; color: #46d67a; }
.col-live .card { border-left-color: #46d67a; }
.col-dd .kanban-col-header { border-color: #fbd75b; color: #fbd75b; }
.col-dd .card { border-left-color: #fbd75b; }
.col-closed .kanban-col-header { border-color: #5C3D14; color: #5C3D14; }
.col-closed .card { border-left-color: #5C3D14; }
.col-signed .kanban-col-header { border-color: #46d6db; color: #46d6db; }
.col-signed .card { border-left-color: #46d6db; }
.col-unsigned .kanban-col-header { border-color: #ff887c; color: #ff887c; }
.col-unsigned .card { border-left-color: #ff887c; }
.col-pending .kanban-col-header { border-color: #fbd75b; color: #fbd75b; }
.col-pending .card { border-left-color: #fbd75b; }

/* To-Do List */
.todo-section { padding: 4px 24px 12px; }
.todo-columns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.todo-column { background: rgba(38,26,5,0.5); border-radius: 8px; padding: 12px; }
.todo-column-header { font-size: 14px; font-weight: 600; color: #C89B5B; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #3a2a10; }
.todo-column-count { background: #3a2a10; color: #C89B5B; font-size: 11px; padding: 1px 7px; border-radius: 10px; margin-left: 6px; }
.todo-list { display: flex; flex-direction: column; gap: 6px; }
@media (max-width: 768px) { .todo-columns { grid-template-columns: 1fr; } }
.todo-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px; background: #261A05; border-radius: 6px; border-left: 3px solid #5C3D14; font-size: 13px; line-height: 1.4; }
.todo-item.high { border-left-color: #ff887c; }
.todo-item.medium { border-left-color: #fbd75b; }
.todo-item.low { border-left-color: #46d67a; }
.todo-check { width: 16px; height: 16px; border: 2px solid #5C3D14; border-radius: 3px; flex-shrink: 0; margin-top: 1px; cursor: pointer; }
.todo-text { flex: 1; color: #FAFAFA; }
.todo-deal { font-size: 10px; color: #7A3B14; background: rgba(122,59,20,0.2); padding: 1px 8px; border-radius: 10px; white-space: nowrap; margin-left: 8px; }
.todo-item .todo-check:hover { border-color: #7A3B14; background: rgba(122,59,20,0.2); }
.todo-item.done { opacity: 0.4; }
.todo-item.done .todo-text { text-decoration: line-through; }
.todo-drag-handle { color: #5C3D14; cursor: grab; font-size: 14px; padding: 0 4px; user-select: none; }
.todo-drag-handle:active { cursor: grabbing; }
.todo-item.dragging { opacity: 0.4; }
.todo-list.drag-over { background: rgba(122,59,20,0.15); border-radius: 6px; min-height: 40px; }
.todo-add-inline { margin-top: 8px; }
.todo-inline-input { width: 100%; padding: 8px 12px; background: #1a1408; border: 1px dashed #3a2a10; border-radius: 6px; color: #FAFAFA; font-family: 'Work Sans', sans-serif; font-size: 13px; outline: none; }
.todo-inline-input:focus { border-color: #7A3B14; border-style: solid; }
.todo-inline-input::placeholder { color: #5C3D14; }
.todo-edit-input { width: 100%; padding: 6px 8px; background: #1a1408; border: 1px solid #7A3B14; border-radius: 4px; color: #FAFAFA; font-family: 'Work Sans', sans-serif; font-size: 13px; outline: none; }
.todo-text { cursor: text; }
.todo-actions { display: none; gap: 4px; align-items: center; margin-left: 6px; flex-shrink: 0; }
.todo-item:hover .todo-actions { display: flex; }
.todo-action-btn { background: none; border: none; cursor: pointer; font-size: 12px; padding: 2px 4px; border-radius: 3px; opacity: 0.6; }
.todo-action-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
.todo-pri-cycle { font-size: 10px; }
.todo-delete { color: #ff887c; font-size: 13px; }

/* Divider */
.divider { height: 1px; background: #5C3D14; margin: 8px 24px; }
/* Weekly Calendar */
.weekly-cal { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 8px 24px; }
.cal-day { background: #261A05; border-radius: 6px; padding: 8px 6px; min-height: 70px; }
.cal-today { border: 1px solid #7A3B14; background: #2a1e0a; }
.cal-day-label { font-family: 'Work Sans', sans-serif; font-size: 11px; font-weight: 600; color: #857D52; margin-bottom: 6px; text-align: center; text-transform: uppercase; letter-spacing: 0.05em; }
.cal-today .cal-day-label { color: #7A3B14; }
.cal-event { font-size: 11px; color: #FAFAFA; padding: 3px 4px; margin-bottom: 3px; background: #3a2a10; border-radius: 3px; line-height: 1.3; }
.cal-time { color: #a67c52; font-weight: 600; font-size: 9px; }
.cal-empty { font-size: 10px; color: #3a3020; text-align: center; padding-top: 10px; }

/* Referrals */
.referrals-section { padding: 8px 24px 16px; }
.ref-row { background: #261A05; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; border-left: 3px solid #a67c52; }
.ref-clients { font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 600; color: #FAFAFA; }
.ref-detail { font-size: 11px; color: #857D52; margin-top: 4px; }
.ref-notes { font-size: 10px; color: #5C3D14; margin-top: 4px; font-style: italic; }

.footer { padding: 16px 24px; text-align: center; font-size: 11px; color: #5C3D14; }

/* MOBILE ‚Äî TABLET */
@media (max-width: 768px) {
  .hdr-top { flex-direction: column; align-items: center; gap: 10px; padding: 12px 16px 8px; }
  .hdr-actions { flex-wrap: wrap; justify-content: center; gap: 6px; }
  .hdr-numbers { flex-wrap: wrap; gap: 4px; padding: 4px 16px 12px; }
  .hn { padding: 0 14px; }
  .hn-num { font-size: 28px; }
  .hn-divider { height: 28px; }
  .stat-num { font-size: 24px; }
  .section-header { padding: 12px 16px 6px; }
  .section-header h2 { font-size: 18px; }
  .kanban { padding: 8px 16px 20px; gap: 10px; }
  .kanban-col { flex: 0 0 200px; }
  .bottom-section { flex-direction: column; padding: 8px 16px; }
  .bottom-right { max-width: unset; min-width: unset; }
  .weekly-cal { grid-template-columns: repeat(7, 1fr); gap: 3px; }
  .cal-day { padding: 6px 4px; min-height: 60px; min-width: 80px; }
  .cal-event { font-size: 9px; padding: 2px 3px; }
  .cal-day-label { font-size: 11px; }
  .card { padding: 10px; }
  .card-address { font-size: 12px; }
  .card-price { font-size: 16px; }
  .card-note { max-width: 175px; }
  .divider { margin: 8px 16px; }
  .footer { padding: 12px 16px; }
}

/* MOBILE ‚Äî PHONE */
@media (max-width: 480px) {
  .hdr-top h1 { font-size: 18px; }
  .hdr-actions { width: 100%; }
  .btn-action { flex: 1; text-align: center; padding: 10px 8px; font-size: 12px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
  .hdr-numbers { gap: 2px; padding: 4px 12px 10px; }
  .hn { padding: 0 8px; }
  .hn-num { font-size: 22px; }
  .hn-lbl { font-size: 8px; }
  .hn-divider { display: none; }
  .kanban { padding: 8px 12px 16px; flex-direction: column; overflow-x: visible; }
  .kanban-col { flex: none; width: 100%; min-width: unset; }
  .card { padding: 12px; }
  .card-address { font-size: 13px; }
  .card-price { font-size: 17px; }
  .card-note { max-width: 100%; font-size: 10px; white-space: normal; }
  .col-header { font-size: 13px; }
  .login-box { padding: 32px 24px; }
  .weekly-cal { grid-template-columns: repeat(3, 1fr); gap: 4px; }
  .cal-day { min-width: unset; min-height: 70px; padding: 8px; }
  .section-header { padding: 10px 12px 4px; }
  .section-header h2 { font-size: 16px; }
  .todo-columns { grid-template-columns: 1fr !important; }
  .bottom-section { padding: 8px 12px; }
}
</style>
</head>
<body>

<!-- PASSWORD GATE -->
<div id="login-gate">
  <div class="login-box">
    <h1>Realty Ryan</h1>
    <div class="sub">Transaction Dashboard</div>
    <div class="login-error" id="login-error">Incorrect password</div>
    <input type="password" id="pw-input" placeholder="Enter password" autofocus>
    <button onclick="checkPw()">Access Dashboard</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="header-compact">
  <div class="hdr-top">
    <h1>Realty Ryan</h1>
    <div class="hdr-actions">
      <a href="new-listing.html" class="btn-action">üè† New Listing</a>
      <a href="new-buyer.html" class="btn-action btn-green">üë§ New Buyer</a>
      <a href="write-offer.html" class="btn-action btn-offer">üìù Write Offer</a>
      <a href="listing-appointment.html" class="btn-action btn-purple">üìã Listing Appt</a>
    </div>
  </div>
  <div class="hdr-numbers">
    <div class="hn"><span class="hn-num" id="stat-active">‚Äî</span><span class="hn-lbl">Active Listings</span></div>
    <div class="hn-divider"></div>
    <div class="hn"><span class="hn-num" id="stat-uc">‚Äî</span><span class="hn-lbl">Under Contract</span></div>
    <div class="hn-divider"></div>
    <div class="hn"><span class="hn-num" id="stat-closed">‚Äî</span><span class="hn-lbl">Closed</span></div>
    <div class="hn-divider"></div>
    <div class="hn"><span class="hn-num" id="stat-buyers">‚Äî</span><span class="hn-lbl">Buyers</span></div>
    <div class="hn-divider"></div>
    <div class="hn vol"><span class="hn-num" id="stat-volume">‚Äî</span><span class="hn-lbl">2026 Volume</span></div>
  </div>
</div>


<div class="section-header">
  <h2>This Week</h2>
</div>
<div class="weekly-cal">
<div class="cal-day cal-today">
  <div class="cal-day-label">Today</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Tue Feb 17</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Wed Feb 18</div>
  <div class="cal-event"><span class="cal-time">3:00 PM</span> üì∏ Interior Photos - 709 Tennyson Dr...</div>

</div>
<div class="cal-day">
  <div class="cal-day-label">Thu Feb 19</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Fri Feb 20</div>
  <div class="cal-event"><span class="cal-time">10:00 AM</span> Listing Appointment ‚Äî 168 Broadsoun...</div>
<div class="cal-event"><span class="cal-time">2:00 PM</span> Listing Appointment ‚Äî 1800 Chestnut...</div>

</div>
<div class="cal-day">
  <div class="cal-day-label">Sat Feb 21</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Sun Feb 22</div>
  <div class="cal-empty">-</div>
</div>
</div>


<div class="section-header">
  <h2>üìå To-Do</h2>
  <span class="section-badge" id="todo-count">0</span>
</div>
<div class="todo-section">
  <div class="todo-columns" style="grid-template-columns: 1fr 1fr;" id="todo-columns-container">
    <!-- Rendered dynamically from Firebase -->
  </div>
</div>
<div class="divider"></div>


<div class="section-label">Listings <span class="sl-count" id="total-listings">‚Äî</span></div>
<div class="kanban" id="listings-kanban">
  <div class="kanban-col col-leads"><div class="kanban-col-header">Leads <span class="count" id="cnt-seller-leads">0</span></div><div class="kanban-cards" id="cards-seller-leads"></div></div>
  <div class="kanban-col" style="border-top-color:#c97a3b;"><div class="kanban-col-header">Listing Appts <span class="count" id="cnt-seller-appt">0</span></div><div class="kanban-cards" id="cards-seller-appt"></div></div>
  <div class="kanban-col col-prep"><div class="kanban-col-header">WIP / Pre-List <span class="count" id="cnt-seller-wip">0</span></div><div class="kanban-cards" id="cards-seller-wip"></div></div>
  <div class="kanban-col col-live"><div class="kanban-col-header">Active <span class="count" id="cnt-seller-active">0</span></div><div class="kanban-cards" id="cards-seller-active"></div></div>
  <div class="kanban-col col-dd"><div class="kanban-col-header">Under Contract <span class="count" id="cnt-seller-uc">0</span></div><div class="kanban-cards" id="cards-seller-uc"></div></div>
  <div class="kanban-col col-closed"><div class="kanban-col-header">Closed <span class="count" id="cnt-seller-closed">0</span></div><div class="kanban-cards" id="cards-seller-closed"></div></div>
</div>

<div class="section-label">Buyers <span class="sl-count" id="total-buyers">‚Äî</span></div>
<div class="kanban" id="buyers-kanban">
  <div class="kanban-col col-hot"><div class="kanban-col-header">Hot Leads üî• <span class="count" id="cnt-buyer-hot">0</span></div><div class="kanban-cards" id="cards-buyer-hot"></div></div>
  <div class="kanban-col col-leads"><div class="kanban-col-header">Leads <span class="count" id="cnt-buyer-leads">0</span></div><div class="kanban-cards" id="cards-buyer-leads"></div></div>
  <div class="kanban-col col-contingent"><div class="kanban-col-header">Contingent on Sale üè† <span class="count" id="cnt-buyer-contingent">0</span></div><div class="kanban-cards" id="cards-buyer-contingent"></div></div>
  <div class="kanban-col col-signed"><div class="kanban-col-header">Active Buyers <span class="count" id="cnt-buyer-signed">0</span></div><div class="kanban-cards" id="cards-buyer-signed"></div></div>
  <div class="kanban-col col-pending"><div class="kanban-col-header">Under Contract <span class="count" id="cnt-buyer-uc">0</span></div><div class="kanban-cards" id="cards-buyer-uc"></div></div>
  <div class="kanban-col col-closed"><div class="kanban-col-header">Closed <span class="count" id="cnt-buyer-closed">0</span></div><div class="kanban-cards" id="cards-buyer-closed"></div></div>
</div>


<div class="section-header" id="referrals-header" style="display:none;">
  <h2>Sent Referrals</h2>
  <span class="section-badge" id="referrals-count">0</span>
</div>
<div class="referrals-section" id="referrals-container"></div>

<div class="footer">Realty Ryan & Associates ¬∑ Powered by Jarvis</div>



</div>



<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
const H="5ae67553136b2ba571f41239f4646eb489bb393b7d25717bf28bbbcdb24f1c04";
function sha256(m){return crypto.subtle.digest("SHA-256",new TextEncoder().encode(m)).then(b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join(""))}
function checkPw(){const p=document.getElementById("pw-input").value;sha256(p).then(h=>{if(h===H){localStorage.setItem("rr_dash_auth","1");show()}else{document.getElementById("login-error").style.display="block"}})}
function show(){document.getElementById("login-gate").style.display="none";document.getElementById("dashboard").style.display="block"}
document.getElementById("pw-input").addEventListener("keydown",e=>{if(e.key==="Enter")checkPw()});
if(localStorage.getItem("rr_dash_auth")==="1")show();

// To-Do functionality ‚Äî drag & drop + inline add
function getLocalTodos(){try{return JSON.parse(localStorage.getItem("rr_todos_v2")||"{}")}catch(e){return{}}}
function saveLocalTodos(t){localStorage.setItem("rr_todos_v2",JSON.stringify(t))}

function renderTodoItem(t, person){
  const deal=t.deal?`<span class="todo-deal">${t.deal}</span>`:"";
  const done=t.done?"done":"";
  return `<div class="todo-item ${t.priority} ${done}" draggable="true" data-id="${t.id}" data-person="${person}" data-priority="${t.priority}"><div class="todo-check" onclick="toggleTodo('${t.id}')"></div><div class="todo-text">${t.text}${deal}</div><div class="todo-actions"><button class="todo-action-btn todo-pri-cycle" onclick="cyclePriority('${t.id}')" title="Change priority">üî¥</button><button class="todo-action-btn todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">‚úï</button></div><div class="todo-drag-handle">‚†ø</div></div>`;
}

// Apply done state + load local todos
(function(){
  const doneTodos=JSON.parse(localStorage.getItem("rr_todos_done")||"{}");
  document.querySelectorAll(".todo-item[data-id]").forEach(el=>{
    if(doneTodos[el.dataset.id])el.classList.add("done");
  });
  // Load locally-added todos into correct columns
  const local=getLocalTodos();
  Object.keys(local).forEach(person=>{
    const list=document.querySelector(`.todo-list[data-person="${person}"]`);
    if(list){
      local[person].forEach(t=>{
        if(!document.querySelector(`.todo-item[data-id="${t.id}"]`)){
          list.insertAdjacentHTML("beforeend",renderTodoItem(t,person));
        }
      });
    }
  });
  updateTodoCount();
  initDragDrop();
})();

function addInlineTodo(input){
  const text=input.value.trim();
  if(!text)return;
  const person=input.dataset.person;
  const id="local-"+Date.now();
  const todo={id:id,text:text,priority:"medium",deal:"",done:false};
  const local=getLocalTodos();
  if(!local[person])local[person]=[];
  local[person].push(todo);
  saveLocalTodos(local);
  const list=input.closest(".todo-column").querySelector(".todo-list");
  list.insertAdjacentHTML("beforeend",renderTodoItem(todo,person));
  initDragDrop();
  input.value="";
    list.ondragleave=function(){this.classList.remove("drag-over")};
    list.ondrop=function(e){
      e.preventDefault();
      this.classList.remove("drag-over");
      if(!dragItem)return;
      const newPerson=this.dataset.person;
      const oldPerson=dragItem.dataset.person;
      dragItem.dataset.person=newPerson;
      this.appendChild(dragItem);
      // Update local storage for moved items
      if(dragItem.dataset.id.startsWith("local-")){
        const local=getLocalTodos();
        if(local[oldPerson]){
          const idx=local[oldPerson].findIndex(t=>t.id===dragItem.dataset.id);
          if(idx>-1){
            const [moved]=local[oldPerson].splice(idx,1);
            if(!local[newPerson])local[newPerson]=[];
            local[newPerson].push(moved);
            saveLocalTodos(local);
          }
        }
      }else{
        // Track server-rendered item moves
        const moves=JSON.parse(localStorage.getItem("rr_todo_moves")||"{}");
        moves[dragItem.dataset.id]=newPerson;
        localStorage.setItem("rr_todo_moves",JSON.stringify(moves));
      }
      updateTodoCount();
    };
  });
}
</script>

</body>
</html>