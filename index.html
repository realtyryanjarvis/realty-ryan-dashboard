<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase handles live updates now -->
<title>Transaction Dashboard ‚Äî Realty Ryan</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #1a1408; font-family: 'Work Sans', sans-serif; color: #FAFAFA; min-height: 100vh; }

/* Password Gate */
#login-gate { display: none; }
#dashboard { display: block; }
.login-box { background: #261A05; padding: 48px; border-radius: 12px; border: 1px solid #5C3D14; width: 100%; max-width: 380px; text-align: center; }
.login-box h1 { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 300; letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 8px; }
.login-box .sub { font-size: 13px; color: #857D52; margin-bottom: 32px; }
.login-box input { width: 100%; padding: 14px 16px; background: #1a1408; border: 1px solid #5C3D14; border-radius: 6px; color: #FAFAFA; font-family: 'Work Sans', sans-serif; font-size: 14px; margin-bottom: 16px; outline: none; }
.login-box input:focus { border-color: #7A3B14; }
.login-box button { width: 100%; padding: 14px; background: #7A3B14; color: #FAFAFA; border: none; border-radius: 6px; font-family: 'Work Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em; }
.login-box button:hover { background: #9A4B1A; }
.login-error { color: #ff887c; font-size: 12px; margin-bottom: 12px; display: none; }

/* Header */
.header-compact { background: #261A05; border-bottom: 2px solid #7A3B14; }
.hdr-top { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px 10px; }
.hdr-top h1 { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 300; letter-spacing: 0.12em; text-transform: uppercase; color: #FAFAFA; margin: 0; }
.hdr-actions { display: flex; gap: 6px; }
.btn-action { padding: 6px 12px; background: #7A3B14; color: #FAFAFA; border-radius: 4px; font-size: 11px; font-weight: 600; text-decoration: none; text-transform: uppercase; letter-spacing: 0.05em; }
.btn-action:hover { background: #9A4B1A; text-decoration: none; }
.btn-offer { background: #c97a3b !important; }
.btn-offer:hover { background: #e08a42 !important; }
.btn-green { background: #2a5a3a; }
.btn-green:hover { background: #3a7a4a; }
.btn-purple { background: #3a2a5a; }
.btn-purple:hover { background: #4a3a7a; }
.hdr-numbers { display: flex; justify-content: center; align-items: center; gap: 0; padding: 8px 24px 14px; }
.hn { text-align: center; padding: 0 24px; }
.hn-num { font-family: 'Cormorant Garamond', serif; font-size: 36px; font-weight: 600; color: #FAFAFA; display: block; line-height: 1; }
.hn-lbl { font-size: 10px; color: #857D52; text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; display: block; }
.hn.vol .hn-num { color: #7A3B14; }
.hn-divider { width: 1px; height: 36px; background: #3a2a10; }
.section-label { padding: 10px 24px 4px; font-family: 'Work Sans', sans-serif; font-size: 13px; font-weight: 600; color: #857D52; text-transform: uppercase; letter-spacing: 0.1em; }
.sl-count { color: #5C3D14; font-weight: 400; }
.new-listing-btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; background: #7A3B14; color: #FAFAFA; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; transition: background 0.2s; }
.new-listing-btn:hover { background: #9A4B1A; }
/* Bottom Section */
.bottom-section { display: flex; gap: 20px; padding: 12px 24px 16px; }
.bottom-left { flex: 2; min-width: 0; }
.bottom-right { flex: 1; min-width: 260px; max-width: 340px; }
.stat { text-align: center; }
.stat-num { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 600; color: #7A3B14; }
.stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: #857D52; }

/* Section Headers */
.section-header { padding: 16px 24px 8px; display: flex; align-items: center; gap: 12px; }
.section-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 600; color: #FAFAFA; letter-spacing: 0.08em; }
.section-badge { background: #7A3B14; color: #FAFAFA; font-size: 11px; font-weight: 600; padding: 2px 10px; border-radius: 12px; }

/* Kanban Board */
.kanban { display: flex; gap: 12px; padding: 12px 24px 24px; overflow-x: auto; min-height: 200px; -webkit-overflow-scrolling: touch; }
.kanban-col { flex: 0 0 240px; background: #261A05; border-radius: 8px; overflow: hidden; }
.kanban-col-header { padding: 12px 14px 8px; border-bottom: 2px solid; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; display: flex; justify-content: space-between; align-items: center; }
.kanban-col-header .count { background: rgba(255,255,255,0.1); padding: 1px 8px; border-radius: 10px; font-size: 11px; }
.kanban-cards { padding: 8px; display: flex; flex-direction: column; gap: 8px; }

/* Cards */
.card { background: #1a1408; border-radius: 6px; padding: 12px; border-left: 3px solid; cursor: pointer; transition: transform 0.15s; display: block; }
.card:hover { transform: translateY(-1px); }
.card-address { font-weight: 600; font-size: 13px; color: #FAFAFA; margin-bottom: 3px; }
.card-sublabel { font-size: 10px; font-weight: 600; color: #7A3B14; text-transform: uppercase; letter-spacing: 1px; padding: 4px 0 6px; border-bottom: 1px solid #3a2a10; margin-bottom: 6px; }
.card-client { font-size: 11px; color: #857D52; margin-bottom: 4px; }
.card-price { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 600; color: #7A3B14; }
.card-note { font-size: 10px; color: #857D52; margin-top: 4px; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 220px; }
.card-meta { display: flex; justify-content: space-between; margin-top: 6px; font-size: 10px; color: #857D52; }

/* Column Colors */
.col-leads .kanban-col-header { border-color: #ff9f6b; color: #ff9f6b; }
.col-hot .kanban-col-header { border-color: #ff4444; color: #ff4444; }
.col-hot .card { border-left-color: #ff4444; }
.col-contingent .kanban-col-header { border-color: #a67c52; color: #a67c52; }
.col-contingent .card { border-left-color: #a67c52; }
.col-leads .card { border-left-color: #ff9f6b; }
.col-prep .kanban-col-header { border-color: #dbadff; color: #dbadff; }
.col-prep .card { border-left-color: #dbadff; }
.col-live .kanban-col-header { border-color: #46d67a; color: #46d67a; }
.col-live .card { border-left-color: #46d67a; }
.col-dd .kanban-col-header { border-color: #fbd75b; color: #fbd75b; }
.col-dd .card { border-left-color: #fbd75b; }
.col-closed .kanban-col-header { border-color: #5C3D14; color: #5C3D14; }
.col-closed .card { border-left-color: #5C3D14; }
.col-signed .kanban-col-header { border-color: #46d6db; color: #46d6db; }
.col-signed .card { border-left-color: #46d6db; }
.col-unsigned .kanban-col-header { border-color: #ff887c; color: #ff887c; }
.col-unsigned .card { border-left-color: #ff887c; }
.col-pending .kanban-col-header { border-color: #fbd75b; color: #fbd75b; }
.col-pending .card { border-left-color: #fbd75b; }

/* To-Do List */
.todo-section { padding: 4px 24px 12px; }
.todo-columns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
.todo-column { background: rgba(38,26,5,0.5); border-radius: 8px; padding: 12px; }
.todo-column-header { font-size: 14px; font-weight: 600; color: #C89B5B; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #3a2a10; }
.todo-column-count { background: #3a2a10; color: #C89B5B; font-size: 11px; padding: 1px 7px; border-radius: 10px; margin-left: 6px; }
.todo-list { display: flex; flex-direction: column; gap: 6px; }
@media (max-width: 768px) { .todo-columns { grid-template-columns: 1fr; } }
.todo-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px; background: #261A05; border-radius: 6px; border-left: 3px solid #5C3D14; font-size: 13px; line-height: 1.4; }
.todo-item.high { border-left-color: #ff887c; }
.todo-item.medium { border-left-color: #fbd75b; }
.todo-item.low { border-left-color: #46d67a; }
.todo-check { width: 16px; height: 16px; border: 2px solid #5C3D14; border-radius: 3px; flex-shrink: 0; margin-top: 1px; cursor: pointer; }
.todo-text { flex: 1; color: #FAFAFA; }
.todo-deal { font-size: 10px; color: #7A3B14; background: rgba(122,59,20,0.2); padding: 1px 8px; border-radius: 10px; white-space: nowrap; margin-left: 8px; }
.todo-item .todo-check:hover { border-color: #7A3B14; background: rgba(122,59,20,0.2); }
.todo-item.done { opacity: 0.4; }
.todo-item.done .todo-text { text-decoration: line-through; }
.todo-drag-handle { color: #5C3D14; cursor: grab; font-size: 14px; padding: 0 4px; user-select: none; }
.todo-drag-handle:active { cursor: grabbing; }
.todo-item.dragging { opacity: 0.4; }
.todo-list.drag-over { background: rgba(122,59,20,0.15); border-radius: 6px; min-height: 40px; }
.todo-add-inline { margin-top: 8px; }
.todo-inline-input { width: 100%; padding: 8px 12px; background: #1a1408; border: 1px dashed #3a2a10; border-radius: 6px; color: #FAFAFA; font-family: 'Work Sans', sans-serif; font-size: 13px; outline: none; }
.todo-inline-input:focus { border-color: #7A3B14; border-style: solid; }
.todo-inline-input::placeholder { color: #5C3D14; }
.todo-edit-input { width: 100%; padding: 6px 8px; background: #1a1408; border: 1px solid #7A3B14; border-radius: 4px; color: #FAFAFA; font-family: 'Work Sans', sans-serif; font-size: 13px; outline: none; }
.todo-text { cursor: text; }
.todo-actions { display: none; gap: 4px; align-items: center; margin-left: 6px; flex-shrink: 0; }
.todo-item:hover .todo-actions { display: flex; }
.todo-action-btn { background: none; border: none; cursor: pointer; font-size: 12px; padding: 2px 4px; border-radius: 3px; opacity: 0.6; }
.todo-action-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
.todo-pri-cycle { font-size: 10px; }
.todo-delete { color: #ff887c; font-size: 13px; }

/* Divider */
.divider { height: 1px; background: #5C3D14; margin: 8px 24px; }
/* Weekly Calendar */
.weekly-cal { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 8px 24px; }
.cal-day { background: #261A05; border-radius: 6px; padding: 8px 6px; min-height: 70px; }
.cal-today { border: 1px solid #7A3B14; background: #2a1e0a; }
.cal-day-label { font-family: 'Work Sans', sans-serif; font-size: 11px; font-weight: 600; color: #857D52; margin-bottom: 6px; text-align: center; text-transform: uppercase; letter-spacing: 0.05em; }
.cal-today .cal-day-label { color: #7A3B14; }
.cal-event { font-size: 11px; color: #FAFAFA; padding: 3px 4px; margin-bottom: 3px; background: #3a2a10; border-radius: 3px; line-height: 1.3; }
.cal-time { color: #a67c52; font-weight: 600; font-size: 9px; }
.cal-empty { font-size: 10px; color: #3a3020; text-align: center; padding-top: 10px; }

/* Referrals */
.referrals-section { padding: 8px 24px 16px; }
.ref-row { background: #261A05; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; border-left: 3px solid #a67c52; }
.ref-clients { font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 600; color: #FAFAFA; }
.ref-detail { font-size: 11px; color: #857D52; margin-top: 4px; }
.ref-notes { font-size: 10px; color: #5C3D14; margin-top: 4px; font-style: italic; }

.footer { padding: 16px 24px; text-align: center; font-size: 11px; color: #5C3D14; }

/* MOBILE ‚Äî TABLET */
@media (max-width: 768px) {
  .hdr-top { flex-direction: column; align-items: center; gap: 10px; padding: 12px 16px 8px; }
  .hdr-actions { flex-wrap: wrap; justify-content: center; gap: 6px; }
  .hdr-numbers { flex-wrap: wrap; gap: 4px; padding: 4px 16px 12px; }
  .hn { padding: 0 14px; }
  .hn-num { font-size: 28px; }
  .hn-divider { height: 28px; }
  .stat-num { font-size: 24px; }
  .section-header { padding: 12px 16px 6px; }
  .section-header h2 { font-size: 18px; }
  .kanban { padding: 8px 16px 20px; gap: 10px; }
  .kanban-col { flex: 0 0 200px; }
  .bottom-section { flex-direction: column; padding: 8px 16px; }
  .bottom-right { max-width: unset; min-width: unset; }
  .weekly-cal { grid-template-columns: repeat(7, 1fr); gap: 3px; }
  .cal-day { padding: 6px 4px; min-height: 60px; min-width: 80px; }
  .cal-event { font-size: 9px; padding: 2px 3px; }
  .cal-day-label { font-size: 11px; }
  .card { padding: 10px; }
  .card-address { font-size: 12px; }
  .card-price { font-size: 16px; }
  .card-note { max-width: 175px; }
  .divider { margin: 8px 16px; }
  .footer { padding: 12px 16px; }
}

/* MOBILE ‚Äî PHONE */
@media (max-width: 480px) {
  .hdr-top h1 { font-size: 18px; }
  .hdr-actions { width: 100%; }
  .btn-action { flex: 1; text-align: center; padding: 10px 8px; font-size: 12px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
  .hdr-numbers { gap: 2px; padding: 4px 12px 10px; }
  .hn { padding: 0 8px; }
  .hn-num { font-size: 22px; }
  .hn-lbl { font-size: 8px; }
  .hn-divider { display: none; }
  .kanban { padding: 8px 12px 16px; flex-direction: column; overflow-x: visible; }
  .kanban-col { flex: none; width: 100%; min-width: unset; }
  .card { padding: 12px; }
  .card-address { font-size: 13px; }
  .card-price { font-size: 17px; }
  .card-note { max-width: 100%; font-size: 10px; white-space: normal; }
  .col-header { font-size: 13px; }
  .login-box { padding: 32px 24px; }
  .weekly-cal { grid-template-columns: repeat(3, 1fr); gap: 4px; }
  .cal-day { min-width: unset; min-height: 70px; padding: 8px; }
  .section-header { padding: 10px 12px 4px; }
  .section-header h2 { font-size: 16px; }
  .todo-columns { grid-template-columns: 1fr !important; }
  .bottom-section { padding: 8px 12px; }
}
</style>
</head>
<body>

<!-- PASSWORD GATE -->
<div id="login-gate">
  <div class="login-box">
    <h1>Realty Ryan</h1>
    <div class="sub">Transaction Dashboard</div>
    <div class="login-error" id="login-error">Incorrect password</div>
    <input type="password" id="pw-input" placeholder="Enter password" autofocus>
    <button onclick="checkPw()">Access Dashboard</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">

<div class="header-compact">
  <div class="hdr-top">
    <h1>Realty Ryan</h1>
    <div class="hdr-actions">
      <a href="new-listing.html" class="btn-action">üè† New Listing</a>
      <a href="new-buyer.html" class="btn-action btn-green">üë§ New Buyer</a>
      <a href="write-offer.html" class="btn-action btn-offer">üìù Write Offer</a>
      <a href="listing-appointment.html" class="btn-action btn-purple">üìã Listing Appt</a>
    </div>
  </div>
  <div class="hdr-numbers">
    <div class="hn"><span class="hn-num" id="stat-active">‚Äî</span><span class="hn-lbl">Active Listings</span></div>
    <div class="hn-divider"></div>
    <div class="hn"><span class="hn-num" id="stat-uc">‚Äî</span><span class="hn-lbl">Under Contract</span></div>
    <div class="hn-divider"></div>
    <div class="hn"><span class="hn-num" id="stat-closed">‚Äî</span><span class="hn-lbl">Closed</span></div>
    <div class="hn-divider"></div>
    <div class="hn"><span class="hn-num" id="stat-buyers">‚Äî</span><span class="hn-lbl">Buyers</span></div>
    <div class="hn-divider"></div>
    <div class="hn vol"><span class="hn-num" id="stat-volume">‚Äî</span><span class="hn-lbl">2026 Volume</span></div>
  </div>
</div>


<div class="section-header">
  <h2>This Week</h2>
</div>
<div class="weekly-cal">
<div class="cal-day cal-today">
  <div class="cal-day-label">Today</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Tue Feb 17</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Wed Feb 18</div>
  <div class="cal-event"><span class="cal-time">3:00 PM</span> üì∏ Interior Photos - 709 Tennyson Dr...</div>

</div>
<div class="cal-day">
  <div class="cal-day-label">Thu Feb 19</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Fri Feb 20</div>
  <div class="cal-event"><span class="cal-time">10:00 AM</span> Listing Appointment ‚Äî 168 Broadsoun...</div>
<div class="cal-event"><span class="cal-time">2:00 PM</span> Listing Appointment ‚Äî 1800 Chestnut...</div>

</div>
<div class="cal-day">
  <div class="cal-day-label">Sat Feb 21</div>
  <div class="cal-empty">-</div>
</div>
<div class="cal-day">
  <div class="cal-day-label">Sun Feb 22</div>
  <div class="cal-empty">-</div>
</div>
</div>


<div class="section-header">
  <h2>üìå To-Do</h2>
  <span class="section-badge" id="todo-count">0</span>
</div>
<div class="todo-section">
  <div class="todo-columns" style="grid-template-columns: 1fr 1fr;" id="todo-columns-container">
    <!-- Rendered dynamically from Firebase -->
  </div>
</div>
<div class="divider"></div>


<div class="section-label">Listings <span class="sl-count" id="total-listings">‚Äî</span></div>
<div class="kanban" id="listings-kanban">
  <div class="kanban-col col-leads"><div class="kanban-col-header">Leads <span class="count" id="cnt-seller-leads">0</span></div><div class="kanban-cards" id="cards-seller-leads"></div></div>
  <div class="kanban-col" style="border-top-color:#c97a3b;"><div class="kanban-col-header">Listing Appts <span class="count" id="cnt-seller-appt">0</span></div><div class="kanban-cards" id="cards-seller-appt"></div></div>
  <div class="kanban-col col-prep"><div class="kanban-col-header">WIP / Pre-List <span class="count" id="cnt-seller-wip">0</span></div><div class="kanban-cards" id="cards-seller-wip"></div></div>
  <div class="kanban-col col-live"><div class="kanban-col-header">Active <span class="count" id="cnt-seller-active">0</span></div><div class="kanban-cards" id="cards-seller-active"></div></div>
  <div class="kanban-col col-dd"><div class="kanban-col-header">Under Contract <span class="count" id="cnt-seller-uc">0</span></div><div class="kanban-cards" id="cards-seller-uc"></div></div>
  <div class="kanban-col col-closed"><div class="kanban-col-header">Closed <span class="count" id="cnt-seller-closed">0</span></div><div class="kanban-cards" id="cards-seller-closed"></div></div>
</div>

<div class="section-label">Buyers <span class="sl-count" id="total-buyers">‚Äî</span></div>
<div class="kanban" id="buyers-kanban">
  <div class="kanban-col col-hot"><div class="kanban-col-header">Hot Leads üî• <span class="count" id="cnt-buyer-hot">0</span></div><div class="kanban-cards" id="cards-buyer-hot"></div></div>
  <div class="kanban-col col-leads"><div class="kanban-col-header">Leads <span class="count" id="cnt-buyer-leads">0</span></div><div class="kanban-cards" id="cards-buyer-leads"></div></div>
  <div class="kanban-col col-contingent"><div class="kanban-col-header">Contingent on Sale üè† <span class="count" id="cnt-buyer-contingent">0</span></div><div class="kanban-cards" id="cards-buyer-contingent"></div></div>
  <div class="kanban-col col-signed"><div class="kanban-col-header">Active Buyers <span class="count" id="cnt-buyer-signed">0</span></div><div class="kanban-cards" id="cards-buyer-signed"></div></div>
  <div class="kanban-col col-pending"><div class="kanban-col-header">Under Contract <span class="count" id="cnt-buyer-uc">0</span></div><div class="kanban-cards" id="cards-buyer-uc"></div></div>
  <div class="kanban-col col-closed"><div class="kanban-col-header">Closed <span class="count" id="cnt-buyer-closed">0</span></div><div class="kanban-cards" id="cards-buyer-closed"></div></div>
</div>


<div class="section-header" id="referrals-header" style="display:none;">
  <h2>Sent Referrals</h2>
  <span class="section-badge" id="referrals-count">0</span>
</div>
<div class="referrals-section" id="referrals-container"></div>

<!-- ========== FORM 2-T WRITE OFFER PANEL ========== -->
<div id="writeOfferPanel" style="display:none;">

  <!-- Deal Bar -->
  <div class="f2t-deal-bar">
    <select id="f2t-deal-select" class="f2t-select" onchange="f2tLoadDeal(this.value)">
      <option value="">‚Äî Load Deal ‚Äî</option>
    </select>
    <input type="text" id="f2t-deal-name" class="f2t-input" placeholder="Deal name (e.g. Smith - 123 Main St)" style="flex:1;">
    <button class="f2t-btn" onclick="f2tSaveDeal()">üíæ Save</button>
    <button class="f2t-btn f2t-btn-danger" onclick="f2tDeleteDeal()">üóë Delete</button>
  </div>

  <!-- MLS Lookup -->
  <div class="f2t-section-card">
    <div class="f2t-section-title">MLS Lookup</div>
    <div class="f2t-mls-row">
      <input type="text" id="f2t-mls-query" class="f2t-input" placeholder="MLS # or Property Address" style="flex:1;">
      <button class="f2t-btn f2t-btn-gold" onclick="f2tMlsLookup()">üîç Pull from MLS</button>
    </div>
    <div id="f2t-mls-banner" class="f2t-banner" style="display:none;"></div>
  </div>

  <!-- Property & Listing Agent Info Card -->
  <div class="f2t-section-card" id="f2t-property-card" style="display:none;">
    <div class="f2t-section-title">Property & Listing Agent Info</div>
    <div class="f2t-readonly-grid">
      <div class="f2t-ro-item"><span class="f2t-ro-label">Address</span><span class="f2t-ro-value" id="f2t-ro-address">‚Äî</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">City / County / Zip</span><span class="f2t-ro-value" id="f2t-ro-city-county-zip">‚Äî</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">PID / PIN</span><span class="f2t-ro-value" id="f2t-ro-pid">‚Äî</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">List Price</span><span class="f2t-ro-value" id="f2t-ro-list-price">‚Äî</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">Listing Agent</span><span class="f2t-ro-value" id="f2t-ro-listing-agent">‚Äî</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">Listing Firm</span><span class="f2t-ro-value" id="f2t-ro-listing-firm">‚Äî</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">Legal Description</span><span class="f2t-ro-value" id="f2t-ro-legal">‚Äî</span></div>
    </div>
  </div>

  <!-- Form Sections -->
  <div class="f2t-form-grid">
    <div class="f2t-section-card">
      <div class="f2t-section-title">Buyer Info</div>
      <label class="f2t-label">Buyer Name</label>
      <input type="text" class="f2t-input" data-field="buyer_name" id="f2t-buyer-name">
      <label class="f2t-label">Buyer 2 Name</label>
      <input type="text" class="f2t-input" data-field="buyer2_name" id="f2t-buyer2-name">
      <label class="f2t-label">Entity Name</label>
      <input type="text" class="f2t-input" data-field="buyer_entity" id="f2t-buyer-entity">
      <label class="f2t-label">Address</label>
      <input type="text" class="f2t-input" data-field="buyer_address" id="f2t-buyer-address">
      <label class="f2t-label">Email</label>
      <input type="email" class="f2t-input" data-field="buyer_email" id="f2t-buyer-email">
      <label class="f2t-label">Phone</label>
      <input type="tel" class="f2t-input" data-field="buyer_phone" id="f2t-buyer-phone">
    </div>
    <div class="f2t-section-card">
      <div class="f2t-section-title">Offer Terms</div>
      <label class="f2t-label">Purchase Price</label>
      <input type="text" class="f2t-input" data-field="purchase_price" id="f2t-purchase-price">
      <label class="f2t-label">Due Diligence Fee</label>
      <input type="text" class="f2t-input" data-field="due_diligence_fee" id="f2t-dd-fee">
      <label class="f2t-label">Earnest Money</label>
      <input type="text" class="f2t-input" data-field="earnest_money" id="f2t-earnest-money">
      <label class="f2t-label">Additional Earnest Money</label>
      <input type="text" class="f2t-input" data-field="additional_earnest" id="f2t-addl-earnest">
      <label class="f2t-label">Seller Concessions</label>
      <input type="text" class="f2t-input" data-field="seller_concession_amount" id="f2t-seller-concessions">
    </div>
    <div class="f2t-section-card">
      <div class="f2t-section-title">Key Dates</div>
      <label class="f2t-label">Due Diligence Deadline</label>
      <input type="date" class="f2t-input" data-field="dd_period_date" id="f2t-dd-deadline">
      <label class="f2t-label">Closing Date</label>
      <input type="date" class="f2t-input" data-field="settlement_date" id="f2t-closing-date">
      <label class="f2t-label">Possession Date</label>
      <input type="date" class="f2t-input" data-field="possession_date" id="f2t-possession-date">
    </div>
    <div class="f2t-section-card">
      <div class="f2t-section-title">Financing</div>
      <label class="f2t-label">Loan Type</label>
      <select class="f2t-select f2t-input" data-field="loan_type" id="f2t-loan-type">
        <option value="">Select‚Ä¶</option>
        <option value="Conventional">Conventional</option>
        <option value="FHA">FHA</option>
        <option value="VA">VA</option>
        <option value="USDA">USDA</option>
        <option value="Cash">Cash</option>
        <option value="Other">Other</option>
      </select>
      <label class="f2t-label">Loan Amount</label>
      <input type="text" class="f2t-input" data-field="loan_amount" id="f2t-loan-amount">
    </div>
    <div class="f2t-section-card">
      <div class="f2t-section-title">Seller Info</div>
      <label class="f2t-label">Seller Name</label>
      <input type="text" class="f2t-input" data-field="seller_name" id="f2t-seller-name">
      <label class="f2t-label">Seller Address</label>
      <input type="text" class="f2t-input" data-field="seller_address" id="f2t-seller-address">
      <label class="f2t-label">Seller Email</label>
      <input type="email" class="f2t-input" data-field="seller_email" id="f2t-seller-email">
      <label class="f2t-label">Seller Phone</label>
      <input type="tel" class="f2t-input" data-field="seller_phone" id="f2t-seller-phone">
    </div>
    <div class="f2t-section-card">
      <div class="f2t-section-title">Escrow</div>
      <label class="f2t-label">Escrow Agent Name</label>
      <input type="text" class="f2t-input" data-field="escrow_agent" id="f2t-escrow-agent">
      <label class="f2t-label">Escrow Agent Address</label>
      <input type="text" class="f2t-input" data-field="escrow_address" id="f2t-escrow-address">
    </div>
    <div class="f2t-section-card">
      <div class="f2t-section-title">Personal Property</div>
      <textarea class="f2t-input f2t-textarea" data-field="personal_property" id="f2t-personal-property" rows="4" placeholder="List personal property included‚Ä¶"></textarea>
    </div>
    <div class="f2t-section-card">
      <div class="f2t-section-title">Additional Terms</div>
      <textarea class="f2t-input f2t-textarea" data-field="additional_terms" id="f2t-additional-terms" rows="4" placeholder="Additional terms and conditions‚Ä¶"></textarea>
    </div>
  </div>

  <!-- Buyer's Agent Card -->
  <div class="f2t-section-card f2t-agent-card">
    <div class="f2t-section-title">Buyer's Agent</div>
    <div class="f2t-readonly-grid f2t-readonly-grid-compact">
      <div class="f2t-ro-item"><span class="f2t-ro-label">Agent</span><span class="f2t-ro-value">Ryan Palmer</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">Firm</span><span class="f2t-ro-value">Corcoran HM Properties</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">License #</span><span class="f2t-ro-value">315654</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">Firm License #</span><span class="f2t-ro-value">C18059</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">Phone</span><span class="f2t-ro-value">508-954-2159</span></div>
      <div class="f2t-ro-item"><span class="f2t-ro-label">Email</span><span class="f2t-ro-value">ryanpalmer@hmproperties.com</span></div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="f2t-actions">
    <button class="f2t-btn f2t-btn-gold" onclick="f2tPreview()">üëÅ Preview</button>
    <button class="f2t-btn" onclick="f2tPrint()">üñ® Print</button>
    <button class="f2t-btn f2t-btn-sign" onclick="f2tSendForSignature()">‚úçÔ∏è Send for Signature</button>
    <button class="f2t-btn f2t-btn-danger" onclick="toggleWriteOffer()">‚úï Close</button>
  </div>

  <!-- Preview Section -->
  <div id="f2t-preview-section" style="display:none;">
    <div class="f2t-section-title" style="padding:16px 0 8px;">Form 2-T Preview</div>
    <div id="f2t-preview-pages"></div>
  </div>

</div>
<!-- ========== END FORM 2-T PANEL ========== -->

<div class="footer">Realty Ryan & Associates ¬∑ Powered by Jarvis</div>



</div>



<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
const H="5ae67553136b2ba571f41239f4646eb489bb393b7d25717bf28bbbcdb24f1c04";
function sha256(m){return crypto.subtle.digest("SHA-256",new TextEncoder().encode(m)).then(b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join(""))}
function checkPw(){const p=document.getElementById("pw-input").value;sha256(p).then(h=>{if(h===H){localStorage.setItem("rr_dash_auth","1");show()}else{document.getElementById("login-error").style.display="block"}})}
function show(){document.getElementById("login-gate").style.display="none";document.getElementById("dashboard").style.display="block"}
document.getElementById("pw-input").addEventListener("keydown",e=>{if(e.key==="Enter")checkPw()});
if(localStorage.getItem("rr_dash_auth")==="1")show();

// To-Do functionality ‚Äî drag & drop + inline add
function getLocalTodos(){try{return JSON.parse(localStorage.getItem("rr_todos_v2")||"{}")}catch(e){return{}}}
function saveLocalTodos(t){localStorage.setItem("rr_todos_v2",JSON.stringify(t))}

function renderTodoItem(t, person){
  const deal=t.deal?`<span class="todo-deal">${t.deal}</span>`:"";
  const done=t.done?"done":"";
  return `<div class="todo-item ${t.priority} ${done}" draggable="true" data-id="${t.id}" data-person="${person}" data-priority="${t.priority}"><div class="todo-check" onclick="toggleTodo('${t.id}')"></div><div class="todo-text">${t.text}${deal}</div><div class="todo-actions"><button class="todo-action-btn todo-pri-cycle" onclick="cyclePriority('${t.id}')" title="Change priority">üî¥</button><button class="todo-action-btn todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">‚úï</button></div><div class="todo-drag-handle">‚†ø</div></div>`;
}

// Apply done state + load local todos
(function(){
  const doneTodos=JSON.parse(localStorage.getItem("rr_todos_done")||"{}");
  document.querySelectorAll(".todo-item[data-id]").forEach(el=>{
    if(doneTodos[el.dataset.id])el.classList.add("done");
  });
  // Load locally-added todos into correct columns
  const local=getLocalTodos();
  Object.keys(local).forEach(person=>{
    const list=document.querySelector(`.todo-list[data-person="${person}"]`);
    if(list){
      local[person].forEach(t=>{
        if(!document.querySelector(`.todo-item[data-id="${t.id}"]`)){
          list.insertAdjacentHTML("beforeend",renderTodoItem(t,person));
        }
      });
    }
  });
  updateTodoCount();
  initDragDrop();
})();

function addInlineTodo(input){
  const text=input.value.trim();
  if(!text)return;
  const person=input.dataset.person;
  const id="local-"+Date.now();
  const todo={id:id,text:text,priority:"medium",deal:"",done:false};
  const local=getLocalTodos();
  if(!local[person])local[person]=[];
  local[person].push(todo);
  saveLocalTodos(local);
  const list=input.closest(".todo-column").querySelector(".todo-list");
  list.insertAdjacentHTML("beforeend",renderTodoItem(todo,person));
  initDragDrop();
  input.value="";
    list.ondragleave=function(){this.classList.remove("drag-over")};
    list.ondrop=function(e){
      e.preventDefault();
      this.classList.remove("drag-over");
      if(!dragItem)return;
      const newPerson=this.dataset.person;
      const oldPerson=dragItem.dataset.person;
      dragItem.dataset.person=newPerson;
      this.appendChild(dragItem);
      // Update local storage for moved items
      if(dragItem.dataset.id.startsWith("local-")){
        const local=getLocalTodos();
        if(local[oldPerson]){
          const idx=local[oldPerson].findIndex(t=>t.id===dragItem.dataset.id);
          if(idx>-1){
            const [moved]=local[oldPerson].splice(idx,1);
            if(!local[newPerson])local[newPerson]=[];
            local[newPerson].push(moved);
            saveLocalTodos(local);
          }
        }
      }else{
        // Track server-rendered item moves
        const moves=JSON.parse(localStorage.getItem("rr_todo_moves")||"{}");
        moves[dragItem.dataset.id]=newPerson;
        localStorage.setItem("rr_todo_moves",JSON.stringify(moves));
      }
      updateTodoCount();
    };
  });
}
</script>

<!-- Form 2-T Styles -->
<style>
#writeOfferPanel { padding: 20px 24px; }
.f2t-deal-bar { display:flex; gap:8px; align-items:center; margin-bottom:16px; flex-wrap:wrap; }
.f2t-input { width:100%; padding:10px 12px; background:#1a1408; border:1px solid #5C3D14; border-radius:6px; color:#FAFAFA; font-family:'Work Sans',sans-serif; font-size:13px; outline:none; }
.f2t-input:focus { border-color:#c97a3b; }
.f2t-select { padding:10px 12px; background:#1a1408; border:1px solid #5C3D14; border-radius:6px; color:#FAFAFA; font-family:'Work Sans',sans-serif; font-size:13px; outline:none; }
.f2t-select:focus { border-color:#c97a3b; }
.f2t-textarea { resize:vertical; min-height:80px; }
.f2t-label { display:block; font-size:11px; color:#857D52; text-transform:uppercase; letter-spacing:0.08em; margin:10px 0 4px; }
.f2t-label:first-of-type { margin-top:0; }
.f2t-btn { padding:10px 18px; background:#7A3B14; color:#FAFAFA; border:none; border-radius:6px; font-family:'Work Sans',sans-serif; font-size:13px; font-weight:600; cursor:pointer; text-transform:uppercase; letter-spacing:0.06em; white-space:nowrap; }
.f2t-btn:hover { background:#9A4B1A; }
.f2t-btn-gold { background:#c97a3b; }
.f2t-btn-gold:hover { background:#e08a42; }
.f2t-btn-danger { background:#5a1a1a; }
.f2t-btn-danger:hover { background:#7a2a2a; }
.f2t-btn-sign { background:#2a5a3a; }
.f2t-btn-sign:hover { background:#3a7a4a; }
.f2t-section-card { background:#261A05; border:1px solid #5C3D14; border-radius:8px; padding:16px; margin-bottom:12px; }
.f2t-section-title { font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:600; color:#c97a3b; margin-bottom:12px; letter-spacing:0.06em; }
.f2t-mls-row { display:flex; gap:8px; }
.f2t-banner { padding:10px 14px; border-radius:6px; font-size:13px; margin-top:10px; }
.f2t-banner.f2t-success { background:rgba(70,214,122,0.15); border:1px solid #46d67a; color:#46d67a; }
.f2t-banner.f2t-error { background:rgba(255,68,68,0.15); border:1px solid #ff4444; color:#ff887c; }
.f2t-readonly-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.f2t-readonly-grid-compact { grid-template-columns:1fr 1fr 1fr; }
.f2t-ro-label { display:block; font-size:10px; color:#857D52; text-transform:uppercase; letter-spacing:0.08em; }
.f2t-ro-value { display:block; font-size:14px; color:#FAFAFA; margin-top:2px; }
.f2t-form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.f2t-agent-card { margin-top:12px; }
.f2t-actions { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
#f2t-preview-section { margin-top:20px; }
.f2t-preview-page { position:relative; margin-bottom:12px; background:#fff; border-radius:4px; overflow:hidden; }
.f2t-preview-page img { width:100%; display:block; }
.f2t-overlay-text { position:absolute; font-family:'Work Sans',sans-serif; color:#000; white-space:nowrap; overflow:hidden; }
.f2t-overlay-check { position:absolute; font-size:14px; font-weight:bold; color:#000; }
@media(max-width:768px){
  .f2t-form-grid { grid-template-columns:1fr; }
  .f2t-readonly-grid-compact { grid-template-columns:1fr 1fr; }
  .f2t-mls-row { flex-direction:column; }
}
@media(max-width:480px){
  .f2t-readonly-grid { grid-template-columns:1fr; }
  .f2t-readonly-grid-compact { grid-template-columns:1fr; }
  .f2t-deal-bar { flex-direction:column; }
  .f2t-actions { flex-direction:column; }
  .f2t-actions .f2t-btn { width:100%; }
}
</style>

<!-- Firebase Live Data -->
<script>
// Initialize Firebase for dashboard data
const dashFirebaseConfig = {
  databaseURL: "https://realtyryan-dashboard-default-rtdb.firebaseio.com"
};
const dashApp = firebase.initializeApp(dashFirebaseConfig, 'dashboard');
const dashDb = firebase.database(dashApp);

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function renderCard(c) {
  let html = `<a href="deals/${c.id}.html" class="card" style="text-decoration:none;color:inherit;">`;
  html += `<div class="card-address">${esc(c.name)}</div>`;
  html += `<div class="card-client">${esc((c.people||[]).join(', '))}</div>`;
  if (c.priceStr && c.price > 0) html += `<div class="card-price">${esc(c.priceStr)}</div>`;
  if (c.note) html += `<div class="card-note">${esc(c.note)}</div>`;
  if (c.dom != null) {
    const domColor = c.dom < 30 ? '#51b749' : c.dom < 60 ? '#fbd75b' : '#ff887c';
    html += `<div class="card-meta"><span style="color:${domColor}">${c.dom} DOM</span></div>`;
  }
  if (c.closingStr) html += `<div class="card-meta"><span>${esc(c.closingStr)}</span></div>`;
  if (c.timeline) {
    const tl = c.timeline.toLowerCase();
    let color = '#46d6db', icon = 'üìÖ';
    if (['now','asap','immediate','active'].some(w => tl.includes(w))) { color = '#ff887c'; icon = 'üî•'; }
    else if (['1 month','next month','march','feb'].some(w => tl.includes(w))) { color = '#fbd75b'; icon = '‚è≥'; }
    html += `<div class="card-timeline" style="color:${color};font-size:11px;margin-top:4px;">${icon} ${esc(c.timeline)}</div>`;
  }
  html += '</a>';
  return html;
}

function renderCards(cards) { return (cards || []).map(renderCard).join(''); }

function setCards(id, cards, cntId) {
  const el = document.getElementById(id);
  if (el) el.innerHTML = renderCards(cards);
  const cnt = document.getElementById(cntId);
  if (cnt) cnt.textContent = (cards || []).length;
}

// Listen for deal changes
dashDb.ref('realty-ryan/deals').on('value', snap => {
  const d = snap.val();
  if (!d) return;

  const s = d.stats || {};
  const si = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
  si('stat-active', s.activeListings);
  si('stat-uc', s.underContract);
  si('stat-closed', s.closed);
  si('stat-buyers', s.buyers);
  si('stat-volume', s.closedVolume);
  si('total-listings', s.totalListings);
  si('total-buyers', s.totalBuyers);

  setCards('cards-seller-leads', d.seller_leads, 'cnt-seller-leads');
  setCards('cards-seller-appt', d.seller_appt, 'cnt-seller-appt');
  setCards('cards-seller-wip', d.seller_wip, 'cnt-seller-wip');
  setCards('cards-seller-uc', d.seller_uc, 'cnt-seller-uc');
  setCards('cards-seller-closed', d.seller_closed, 'cnt-seller-closed');

  const activeEl = document.getElementById('cards-seller-active');
  if (activeEl) {
    let h = '<div class="card-sublabel">Existing Homes</div>';
    h += renderCards(d.seller_existing);
    h += '<div class="card-sublabel" style="margin-top:10px;">To Be Built</div>';
    h += renderCards(d.seller_new_construction);
    activeEl.innerHTML = h;
  }
  const cntActive = document.getElementById('cnt-seller-active');
  if (cntActive) cntActive.textContent = (d.seller_existing||[]).length + (d.seller_new_construction||[]).length;

  setCards('cards-buyer-hot', d.buyer_hot, 'cnt-buyer-hot');
  setCards('cards-buyer-leads', d.buyer_leads, 'cnt-buyer-leads');
  setCards('cards-buyer-contingent', d.buyer_contingent, 'cnt-buyer-contingent');
  setCards('cards-buyer-signed', d.buyer_signed, 'cnt-buyer-signed');
  setCards('cards-buyer-uc', d.buyer_uc, 'cnt-buyer-uc');
  setCards('cards-buyer-closed', d.buyer_closed, 'cnt-buyer-closed');
});

// Listen for todo changes
dashDb.ref('realty-ryan/todos').on('value', snap => {
  const todos = snap.val();
  if (!todos) return;
  const container = document.getElementById('todo-columns-container');
  if (!container) return;

  const personMap = { ryan: 'üë§ Ryan', ally: 'üë©‚Äçüíº Ally', alexis: 'üíÅ Alexis' };
  let html = '';
  let totalCount = 0;

  Object.keys(todos).forEach(person => {
    const items = todos[person] || [];
    if (!Array.isArray(items)) return;
    totalCount += items.length;
    html += `<div class="todo-column" data-person="${person}">`;
    html += `<div class="todo-column-header">${personMap[person] || person} <span class="todo-column-count">${items.length}</span></div>`;
    html += `<div class="todo-list" data-person="${person}">`;
    items.forEach(t => {
      const pri = t.priority || 'medium';
      const deal = t.deal ? `<span class="todo-deal">${esc(t.deal)}</span>` : '';
      html += `<div class="todo-item ${pri}" draggable="true" data-id="${t.id}" data-person="${person}" data-priority="${pri}">`;
      html += `<div class="todo-check" onclick="toggleTodo('${t.id}')"></div>`;
      html += `<div class="todo-text">${esc(t.text)}${deal}</div>`;
      html += `<div class="todo-actions"><button class="todo-action-btn todo-pri-cycle" onclick="cyclePriority('${t.id}')" title="Change priority">üî¥</button><button class="todo-action-btn todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">‚úï</button></div>`;
      html += `<div class="todo-drag-handle">‚†ø</div></div>`;
    });
    html += `</div>`;
    html += `<div class="todo-add-inline"><input type="text" placeholder="+ Add to-do..." class="todo-inline-input" data-person="${person}" onkeydown="if(event.key==='Enter')addInlineTodo(this)"></div>`;
    html += `</div>`;
  });

  container.innerHTML = html;

  // Re-apply local state
  const doneTodos = JSON.parse(localStorage.getItem('rr_todos_done') || '{}');
  const dels = JSON.parse(localStorage.getItem('rr_todo_deletes') || '[]');
  const pris = JSON.parse(localStorage.getItem('rr_todo_priorities') || '{}');
  const edits = JSON.parse(localStorage.getItem('rr_todo_edits') || '{}');

  dels.forEach(id => { const el = document.querySelector(`.todo-item[data-id="${id}"]`); if (el) el.remove(); });
  Object.keys(doneTodos).forEach(id => { const el = document.querySelector(`.todo-item[data-id="${id}"]`); if (el) el.classList.add('done'); });
  Object.keys(pris).forEach(id => {
    const el = document.querySelector(`.todo-item[data-id="${id}"]`);
    if (el) { el.classList.remove('high','medium','low'); el.classList.add(pris[id]); el.dataset.priority = pris[id]; }
  });
  Object.keys(edits).forEach(id => {
    const item = document.querySelector(`.todo-item[data-id="${id}"]`);
    if (item) { const t = item.querySelector('.todo-text'); if (t && t.childNodes[0]) t.childNodes[0].textContent = edits[id]; }
  });

  // Load locally-added todos
  const local = getLocalTodos();
  Object.keys(local).forEach(person => {
    const list = document.querySelector(`.todo-list[data-person="${person}"]`);
    if (list) {
      local[person].forEach(t => {
        if (!document.querySelector(`.todo-item[data-id="${t.id}"]`)) {
          list.insertAdjacentHTML('beforeend', renderTodoItem(t, person));
        }
      });
    }
  });

  updateTodoCount();
  initDragDrop();
});

// Listen for referral changes
dashDb.ref('realty-ryan/referrals').on('value', snap => {
  const refs = snap.val();
  if (!refs || !refs.length) return;
  const active = refs.filter(r => r.status === 'Active');
  if (!active.length) return;
  document.getElementById('referrals-header').style.display = 'flex';
  document.getElementById('referrals-count').textContent = active.length;
  document.getElementById('referrals-container').innerHTML = active.map(r => `
    <div class="ref-row">
      <div class="ref-clients">${esc(r.clients)}</div>
      <div class="ref-detail">${esc(r.location)} &middot; Agent: ${esc(r.agent)} &middot; Fee: ${esc(r.referralFee)}</div>
      ${r.notes ? `<div class="ref-notes">${esc(r.notes)}</div>` : ''}
    </div>`).join('');
});

// Listen for lastUpdated
dashDb.ref('realty-ryan/lastUpdated').on('value', snap => {
  const ts = snap.val();
  if (!ts) return;
  const bar = document.getElementById('last-updated-bar');
  if (!bar) return;
  const dt = new Date(ts);
  function updateAgo() {
    const now = new Date();
    const diffMin = Math.floor((now - dt) / 60000);
    let ago;
    if (diffMin < 1) ago = 'just now';
    else if (diffMin < 60) ago = diffMin + 'm ago';
    else if (diffMin < 1440) ago = Math.floor(diffMin/60) + 'h ago';
    else ago = Math.floor(diffMin/1440) + 'd ago';
    bar.textContent = 'Last updated: ' + ago + ' ¬∑ ' + dt.toLocaleString();
  }
  updateAgo();
  clearInterval(window._lastUpdInterval);
  window._lastUpdInterval = setInterval(updateAgo, 60000);
});
</script>

<!-- Form 2-T JavaScript -->
<script>
const f2tFirebaseConfig = {
  apiKey: "AIzaSyCLnvrTIIsshy0nP7z1BEAyFZdGeJ-hJwQ",
  authDomain: "realtyryan-dashboard.firebaseapp.com",
  databaseURL: "https://realtyryan-dashboard-default-rtdb.firebaseio.com",
  projectId: "realtyryan-dashboard",
  storageBucket: "realtyryan-dashboard.firebasestorage.app",
  messagingSenderId: "40229133129",
  appId: "1:40229133129:web:be8ca0f35c778427301898"
};
const f2tApp = firebase.initializeApp(f2tFirebaseConfig, 'form2t');
const f2tDb = firebase.database(f2tApp);
const f2tDealsRef = f2tDb.ref('realty-ryan/form2t_deals');

let f2tMappings = null;
fetch('forms/form2t-mappings-clean.json').then(r=>r.json()).then(d=>{f2tMappings=d}).catch(()=>{});

const F2T_AGENT = {
  buyer_agent_name: 'Ryan Palmer',
  buyer_agent_firm: 'Corcoran HM Properties',
  buyer_agent_license: '315654',
  buyer_agent_firm_license: 'C18059',
  buyer_agent_phone: '508-954-2159',
  buyer_agent_email: 'ryanpalmer@hmproperties.com'
};

function toggleWriteOffer() {
  const panel = document.getElementById('writeOfferPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    panel.style.display = 'none';
  }
}

function f2tGetFormData() {
  const data = {};
  document.querySelectorAll('#writeOfferPanel [data-field]').forEach(el => {
    data[el.dataset.field] = el.value;
  });
  Object.assign(data, F2T_AGENT);
  return data;
}

function f2tSetFormData(data) {
  if (!data) return;
  document.querySelectorAll('#writeOfferPanel [data-field]').forEach(el => {
    if (data[el.dataset.field] !== undefined) el.value = data[el.dataset.field];
  });
}

async function f2tMlsLookup() {
  const q = document.getElementById('f2t-mls-query').value.trim();
  if (!q) return;
  const banner = document.getElementById('f2t-mls-banner');
  banner.style.display = 'block';
  banner.className = 'f2t-banner';
  banner.textContent = 'Searching MLS‚Ä¶';
  try {
    const isNum = /^\d+$/.test(q);
    let url = isNum
      ? `https://api.idxbroker.com/mls/listing/${q}`
      : `https://api.idxbroker.com/mls/searchresults?query=${encodeURIComponent(q)}`;
    const resp = await fetch(url, {
      headers: { 'accesskey': 'n7sPFcEjrAnAihx-uq46z8', 'Content-Type': 'application/x-www-form-urlencoded' }
    });
    if (!resp.ok) throw new Error('MLS lookup failed: ' + resp.status);
    const result = await resp.json();
    const listing = Array.isArray(result) ? result[0] : result;
    if (!listing) throw new Error('No results found');
    const addr = listing.address || listing.streetName || '';
    const city = listing.cityName || listing.city || '';
    const county = listing.countyName || listing.county || '';
    const zip = listing.zipcode || listing.zip || '';
    const pid = listing.parcelNumber || listing.pid || '';
    const legal = listing.legalDescription || '';
    const listPrice = listing.listingPrice || listing.price || '';
    const listAgent = listing.listingAgentName || listing.agentName || '';
    const listFirm = listing.listingOfficeName || listing.officeName || '';
    document.getElementById('f2t-ro-address').textContent = addr;
    document.getElementById('f2t-ro-city-county-zip').textContent = `${city}, ${county}, ${zip}`;
    document.getElementById('f2t-ro-pid').textContent = pid;
    document.getElementById('f2t-ro-list-price').textContent = listPrice ? `$${Number(listPrice).toLocaleString()}` : '‚Äî';
    document.getElementById('f2t-ro-listing-agent').textContent = listAgent;
    document.getElementById('f2t-ro-listing-firm').textContent = listFirm;
    document.getElementById('f2t-ro-legal').textContent = legal || '‚Äî';
    const si = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
    si('f2t-seller-name', listing.ownerName || '');
    si('f2t-purchase-price', '');
    if (listPrice) document.getElementById('f2t-purchase-price').placeholder = `List: $${Number(listPrice).toLocaleString()}`;
    window.f2tMlsData = { street_address: addr, city, county, zip_code: zip, pid_pin: pid, other_description: legal, seller_name: listing.ownerName || '' };
    document.getElementById('f2t-property-card').style.display = 'block';
    banner.className = 'f2t-banner f2t-success';
    banner.textContent = '‚úì Property data loaded from MLS';
  } catch (err) {
    banner.className = 'f2t-banner f2t-error';
    banner.textContent = '‚úï ' + err.message;
  }
}

function f2tGetDeals() {
  try { return JSON.parse(localStorage.getItem('rr_form2t_deals') || '{}'); } catch(e) { return {}; }
}
function f2tSaveDeals(deals) {
  localStorage.setItem('rr_form2t_deals', JSON.stringify(deals));
  f2tSyncToFirebase(deals);
}
function f2tSyncToFirebase(deals) {
  try { f2tDealsRef.set(deals); } catch(e) { console.warn('Firebase sync failed', e); }
}
f2tDealsRef.on('value', snap => {
  const fbDeals = snap.val();
  if (fbDeals) {
    localStorage.setItem('rr_form2t_deals', JSON.stringify(fbDeals));
    f2tPopulateDealSelect();
  }
});
function f2tPopulateDealSelect() {
  const sel = document.getElementById('f2t-deal-select');
  const deals = f2tGetDeals();
  sel.innerHTML = '<option value="">‚Äî Load Deal ‚Äî</option>';
  Object.keys(deals).forEach(k => {
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = k;
    sel.appendChild(opt);
  });
}
function f2tSaveDeal() {
  const name = document.getElementById('f2t-deal-name').value.trim();
  if (!name) { alert('Enter a deal name first.'); return; }
  const deals = f2tGetDeals();
  deals[name] = { ...f2tGetFormData(), _mlsData: window.f2tMlsData || null, _updated: new Date().toISOString() };
  f2tSaveDeals(deals);
  f2tPopulateDealSelect();
  document.getElementById('f2t-deal-select').value = name;
  f2tShowBanner('f2t-mls-banner', 'üíæ Deal saved: ' + name, true);
}
function f2tLoadDeal(name) {
  if (!name) return;
  const deals = f2tGetDeals();
  const deal = deals[name];
  if (!deal) return;
  document.getElementById('f2t-deal-name').value = name;
  f2tSetFormData(deal);
  if (deal._mlsData) {
    window.f2tMlsData = deal._mlsData;
    const m = deal._mlsData;
    document.getElementById('f2t-ro-address').textContent = m.street_address || '‚Äî';
    document.getElementById('f2t-ro-city-county-zip').textContent = `${m.city||''}, ${m.county||''}, ${m.zip_code||''}`;
    document.getElementById('f2t-ro-pid').textContent = m.pid_pin || '‚Äî';
    document.getElementById('f2t-ro-legal').textContent = m.other_description || '‚Äî';
    document.getElementById('f2t-property-card').style.display = 'block';
  }
}
function f2tDeleteDeal() {
  const name = document.getElementById('f2t-deal-select').value || document.getElementById('f2t-deal-name').value.trim();
  if (!name) return;
  if (!confirm('Delete deal "' + name + '"?')) return;
  const deals = f2tGetDeals();
  delete deals[name];
  f2tSaveDeals(deals);
  f2tPopulateDealSelect();
  document.getElementById('f2t-deal-name').value = '';
  f2tShowBanner('f2t-mls-banner', 'üóë Deal deleted', false);
}
function f2tShowBanner(id, msg, isSuccess) {
  const b = document.getElementById(id);
  b.style.display = 'block';
  b.className = 'f2t-banner ' + (isSuccess ? 'f2t-success' : 'f2t-error');
  b.textContent = msg;
  setTimeout(() => { b.style.display = 'none'; }, 3000);
}
function f2tPreview() {
  const section = document.getElementById('f2t-preview-section');
  const pages = document.getElementById('f2t-preview-pages');
  if (section.style.display !== 'none') { section.style.display = 'none'; return; }
  pages.innerHTML = '';
  const formData = f2tGetFormData();
  if (window.f2tMlsData) Object.assign(formData, window.f2tMlsData);
  const IMG_W = 612;
  for (let p = 1; p <= 14; p++) {
    const container = document.createElement('div');
    container.className = 'f2t-preview-page';
    const img = document.createElement('img');
    img.src = `forms/images/form2t-page-${p}.png`;
    img.alt = `Page ${p}`;
    container.appendChild(img);
    if (f2tMappings && f2tMappings[String(p)]) {
      f2tMappings[String(p)].forEach(field => {
        const val = formData[field.name];
        if (!val) return;
        if (field.type === 'checkbox') {
          if (val === 'true' || val === true || val === '‚úì') {
            const chk = document.createElement('div');
            chk.className = 'f2t-overlay-check';
            chk.textContent = '‚úì';
            chk.style.left = (field.x / IMG_W * 100) + '%';
            chk.style.top = (field.y / 792 * 100) + '%';
            chk.style.fontSize = (field.fontSize || 10) + 'px';
            container.appendChild(chk);
          }
        } else {
          const txt = document.createElement('div');
          txt.className = 'f2t-overlay-text';
          txt.textContent = val;
          txt.style.left = (field.x / IMG_W * 100) + '%';
          txt.style.top = (field.y / 792 * 100) + '%';
          txt.style.fontSize = (field.fontSize || 10) + 'px';
          txt.style.maxWidth = (field.w / IMG_W * 100) + '%';
          container.appendChild(txt);
        }
      });
    }
    pages.appendChild(container);
  }
  section.style.display = 'block';
  section.scrollIntoView({ behavior: 'smooth' });
}
function f2tPrint() {
  f2tPreview();
  setTimeout(() => window.print(), 500);
}
async function f2tSendForSignature() {
  const buyerEmail = document.getElementById('f2t-buyer-email').value.trim();
  const buyerName = document.getElementById('f2t-buyer-name').value.trim();
  const sellerEmail = document.getElementById('f2t-seller-email').value.trim();
  const sellerName = document.getElementById('f2t-seller-name').value.trim();
  if (!buyerEmail || !buyerName) { alert('Buyer name and email are required.'); return; }
  if (!sellerEmail || !sellerName) { alert('Seller name and email are required.'); return; }
  if (!confirm(`Send Form 2-T for signature to:\n‚Ä¢ ${buyerName} (${buyerEmail})\n‚Ä¢ ${sellerName} (${sellerEmail})\n\nProceed?`)) return;
  const dealName = document.getElementById('f2t-deal-name').value.trim() || 'Form 2-T';
  try {
    const formData = new FormData();
    formData.append('title', `Form 2-T: ${dealName}`);
    formData.append('subject', `Offer to Purchase - ${dealName}`);
    formData.append('message', 'Please review and sign the attached Form 2-T Offer to Purchase and Contract.');
    formData.append('signers[0][email_address]', buyerEmail);
    formData.append('signers[0][name]', buyerName);
    formData.append('signers[0][order]', '0');
    formData.append('signers[1][email_address]', sellerEmail);
    formData.append('signers[1][name]', sellerName);
    formData.append('signers[1][order]', '1');
    formData.append('test_mode', '1');
    const resp = await fetch('https://api.hellosign.com/v3/signature_request/send', {
      method: 'POST',
      headers: { 'Authorization': 'Basic ' + btoa('589ba5d3f3c5a635352c09254515e984c01d5e29529b1284ba8eb32b976d16c8:') },
      body: formData
    });
    if (!resp.ok) throw new Error('Dropbox Sign error: ' + resp.status);
    const result = await resp.json();
    f2tShowBanner('f2t-mls-banner', '‚úçÔ∏è Signature request sent! ID: ' + (result.signature_request?.signature_request_id || 'sent'), true);
  } catch (err) {
    f2tShowBanner('f2t-mls-banner', '‚úï Signature error: ' + err.message, false);
  }
}
f2tPopulateDealSelect();
</script>

</body>
</html>