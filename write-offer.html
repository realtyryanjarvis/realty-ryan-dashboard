<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Write Offer ‚Äî Realty Ryan</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #1a1408; font-family: 'Work Sans', sans-serif; color: #FAFAFA; min-height: 100vh; }
.header-compact { background: #261A05; border-bottom: 2px solid #7A3B14; }
.hdr-top { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px 10px; }
.hdr-top h1 { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 300; letter-spacing: 0.12em; text-transform: uppercase; color: #FAFAFA; margin: 0; }
.btn-action { padding: 8px 16px; background: #7A3B14; color: #FAFAFA; border-radius: 4px; font-size: 12px; font-weight: 600; text-decoration: none; text-transform: uppercase; letter-spacing: 0.05em; }
.btn-action:hover { background: #9A4B1A; text-decoration: none; }
  if(dealSpan)textEl.appendChild(dealSpan);
  input.focus();
  input.select();
  function save(){
    const newText=input.value.trim();
    if(!newText)return cancel();
    textEl.innerHTML="";
    textEl.appendChild(document.createTextNode(newText));
    if(dealSpan){textEl.appendChild(document.createTextNode(" "));textEl.appendChild(dealSpan)}
    // Save edit to localStorage
    const id=item.dataset.id;
    const edits=JSON.parse(localStorage.getItem("rr_todo_edits")||"{}");
    edits[id]=newText;
    localStorage.setItem("rr_todo_edits",JSON.stringify(edits));
    // Also update local todos if applicable
    const person=item.dataset.person;
    const local=getLocalTodos();
    if(local[person]){
      const lt=local[person].find(t=>t.id===id);
      if(lt){lt.text=newText;saveLocalTodos(local)}
    }
  }
  function cancel(){
    textEl.innerHTML="";
    textEl.appendChild(document.createTextNode(currentText));
    if(dealSpan){textEl.appendChild(document.createTextNode(" "));textEl.appendChild(dealSpan)}
  }
  input.addEventListener("keydown",function(ev){
    if(ev.key==="Enter"){ev.preventDefault();save()}
    if(ev.key==="Escape")cancel();
  });
  input.addEventListener("blur",save);
});

// Apply saved edits on load
(function(){
  const edits=JSON.parse(localStorage.getItem("rr_todo_edits")||"{}");
  Object.keys(edits).forEach(id=>{
    const item=document.querySelector(`.todo-item[data-id="${id}"]`);
    if(item){
      const textEl=item.querySelector(".todo-text");
      const dealSpan=textEl.querySelector(".todo-deal");
      textEl.innerHTML="";
      textEl.appendChild(document.createTextNode(edits[id]));
      if(dealSpan){textEl.appendChild(document.createTextNode(" "));textEl.appendChild(dealSpan)}
    }
  });
})();

// Drag & Drop
</style>
</head>
<body>

<div class="header-compact">
  <div class="hdr-top">
    <h1>üìù Write Offer ‚Äî Form 2-T</h1>
    <a href="index.html" class="btn-action">‚Üê Back to Dashboard</a>
  </div>
</div>

<div style="padding: 20px 24px;">
  });
  updateTodoCount();
  initDragDrop();
})();

function addInlineTodo(input){
  const text=input.value.trim();
  if(!text)return;
  const person=input.dataset.person;
  const id="local-"+Date.now();
  const todo={id:id,text:text,priority:"medium",deal:"",done:false};
  const local=getLocalTodos();
  if(!local[person])local[person]=[];
  local[person].push(todo);
  saveLocalTodos(local);
  const list=input.closest(".todo-column").querySelector(".todo-list");
  list.insertAdjacentHTML("beforeend",renderTodoItem(todo,person));
  initDragDrop();
  input.value="";
  updateTodoCount();
  // Track unsent items for Jarvis sync
  const unsent=JSON.parse(localStorage.getItem("rr_todo_unsent")||"[]");
  const personName=person.charAt(0).toUpperCase()+person.slice(1);
  unsent.push({person:personName,text:text,time:new Date().toLocaleString()});
  localStorage.setItem("rr_todo_unsent",JSON.stringify(unsent));
  showSyncBadge();
}

// Sync badge ‚Äî shows when there are unsent todos for Jarvis
function showSyncBadge(){
  const unsent=JSON.parse(localStorage.getItem("rr_todo_unsent")||"[]");
  let badge=document.getElementById("jarvis-sync-badge");
  if(unsent.length===0){if(badge)badge.style.display="none";return}
  if(!badge){
    badge=document.createElement("div");
    badge.id="jarvis-sync-badge";
    badge.style.cssText="position:fixed;bottom:20px;right:20px;background:#7A3B14;color:#FAFAFA;padding:10px 16px;border-radius:24px;cursor:pointer;font-size:13px;font-family:Work Sans,sans-serif;z-index:9999;box-shadow:0 2px 12px rgba(0,0,0,0.4);display:flex;align-items:center;gap:8px;";
    badge.onclick=syncToJarvis;
    document.body.appendChild(badge);
  }
  badge.innerHTML=`ü§ñ <span>${unsent.length} new todo${unsent.length>1?"s":""}</span> <span style="background:rgba(255,255,255,0.2);padding:2px 10px;border-radius:12px;font-weight:600;">Send to Jarvis</span>`;
  badge.style.display="flex";
}

function syncToJarvis(){
  const unsent=JSON.parse(localStorage.getItem("rr_todo_unsent")||"[]");
  if(unsent.length===0)return;
  let msg="üìå NEW TODOS from dashboard:
";
  unsent.forEach(t=>{msg+=`
‚Ä¢ ${t.person}: ${t.text}`});
  window.open("sms:+15089542159&body="+encodeURIComponent(msg),"_blank");
  localStorage.setItem("rr_todo_unsent","[]");
  showSyncBadge();
}

// Show badge on load if unsent items exist
showSyncBadge();

function toggleTodo(id){
  const el=document.querySelector(`.todo-item[data-id="${id}"]`);
  if(!el)return;
  el.classList.toggle("done");
  const doneTodos=JSON.parse(localStorage.getItem("rr_todos_done")||"{}");
  if(el.classList.contains("done")){doneTodos[id]=true}else{delete doneTodos[id]}
  localStorage.setItem("rr_todos_done",JSON.stringify(doneTodos));
  // For local todos
  const local=getLocalTodos();
  const person=el.dataset.person;
  if(local[person]){
    const lt=local[person].find(t=>t.id===id);
    if(lt){lt.done=!lt.done;saveLocalTodos(local)}
  }
  updateTodoCount();
}

function updateTodoCount(){
  const all=document.querySelectorAll(".todo-item");
  const active=[...all].filter(e=>!e.classList.contains("done")).length;
  const ct=document.getElementById("todo-count");
  if(ct)ct.textContent=active;
  // Update per-column counts
  document.querySelectorAll(".todo-column").forEach(col=>{
    const items=col.querySelectorAll(".todo-item");
    const activeCol=[...items].filter(e=>!e.classList.contains("done")).length;
    const badge=col.querySelector(".todo-column-count");
    if(badge)badge.textContent=activeCol;
  });
}

// Delete todo
function deleteTodo(id){
  const item=document.querySelector(`.todo-item[data-id="${id}"]`);
  if(!item)return;
  item.style.transition="opacity 0.2s";item.style.opacity="0";
  setTimeout(()=>{
    item.remove();
    // Remove from local todos
    const person=item.dataset.person;
    const local=getLocalTodos();
    if(local[person]){
      local[person]=local[person].filter(t=>t.id!==id);
      saveLocalTodos(local);
    }
    // Track server-rendered deletions
    const dels=JSON.parse(localStorage.getItem("rr_todo_deletes")||"[]");
    if(!dels.includes(id))dels.push(id);
    localStorage.setItem("rr_todo_deletes",JSON.stringify(dels));
    updateTodoCount();
  },200);
}

// Cycle priority: high ‚Üí medium ‚Üí low ‚Üí high
function cyclePriority(id){
  const item=document.querySelector(`.todo-item[data-id="${id}"]`);
  if(!item)return;
  const order=["high","medium","low"];
  const current=item.dataset.priority||"medium";
  const next=order[(order.indexOf(current)+1)%3];
  item.classList.remove("high","medium","low");
  item.classList.add(next);
  item.dataset.priority=next;
  // Save priority change
  const pris=JSON.parse(localStorage.getItem("rr_todo_priorities")||"{}");
  pris[id]=next;
  localStorage.setItem("rr_todo_priorities",JSON.stringify(pris));
  // Update local todos
  const person=item.dataset.person;
  const local=getLocalTodos();
  if(local[person]){
    const lt=local[person].find(t=>t.id===id);
    if(lt){lt.priority=next;saveLocalTodos(local)}
  }
}

// Apply saved deletions and priorities on load
(function(){
  const dels=JSON.parse(localStorage.getItem("rr_todo_deletes")||"[]");
  dels.forEach(id=>{
    const el=document.querySelector(`.todo-item[data-id="${id}"]`);
    if(el)el.remove();
  });
  const pris=JSON.parse(localStorage.getItem("rr_todo_priorities")||"{}");
  Object.keys(pris).forEach(id=>{
    const el=document.querySelector(`.todo-item[data-id="${id}"]`);
    if(el){
      el.classList.remove("high","medium","low");
      el.classList.add(pris[id]);
      el.dataset.priority=pris[id];
    }
  });
})();

// Edit todo on double-click
document.addEventListener("dblclick",function(e){
  const textEl=e.target.closest(".todo-text");
  if(!textEl)return;
  const item=textEl.closest(".todo-item");
  if(!item||item.querySelector(".todo-edit-input"))return;
  const currentText=textEl.childNodes[0]?textEl.childNodes[0].textContent.trim():textEl.textContent.trim();
  const input=document.createElement("input");
  input.type="text";
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

// Print
function f2tPrint() {
  f2tPreview();
  setTimeout(() => window.print(), 500);
}

// Send for Signature via Dropbox Sign
async function f2tSendForSignature() {
  const buyerEmail = document.getElementById('f2t-buyer-email').value.trim();
  const buyerName = document.getElementById('f2t-buyer-name').value.trim();
  const sellerEmail = document.getElementById('f2t-seller-email').value.trim();
  const sellerName = document.getElementById('f2t-seller-name').value.trim();

  if (!buyerEmail || !buyerName) { alert('Buyer name and email are required.'); return; }
  if (!sellerEmail || !sellerName) { alert('Seller name and email are required.'); return; }

  if (!confirm(`Send Form 2-T for signature to:
‚Ä¢ ${buyerName} (${buyerEmail})
‚Ä¢ ${sellerName} (${sellerEmail})

Proceed?`)) return;

  const dealName = document.getElementById('f2t-deal-name').value.trim() || 'Form 2-T';

  try {
    const formData = new FormData();
    formData.append('title', `Form 2-T: ${dealName}`);
    formData.append('subject', `Offer to Purchase - ${dealName}`);
    formData.append('message', 'Please review and sign the attached Form 2-T Offer to Purchase and Contract.');
    formData.append('signers[0][email_address]', buyerEmail);
    formData.append('signers[0][name]', buyerName);
    formData.append('signers[0][order]', '0');
    formData.append('signers[1][email_address]', sellerEmail);
    formData.append('signers[1][name]', sellerName);
    formData.append('signers[1][order]', '1');
    formData.append('test_mode', '1');

    const resp = await fetch('https://api.hellosign.com/v3/signature_request/send', {
      method: 'POST',
      headers: { 'Authorization': 'Basic ' + btoa('589ba5d3f3c5a635352c09254515e984c01d5e29529b1284ba8eb32b976d16c8:') },
      body: formData
    });

    if (!resp.ok) throw new Error('Dropbox Sign error: ' + resp.status);
    const result = await resp.json();
    f2tShowBanner('f2t-mls-banner', '‚úçÔ∏è Signature request sent! ID: ' + (result.signature_request?.signature_request_id || 'sent'), true);
  } catch (err) {
    f2tShowBanner('f2t-mls-banner', '‚úï Signature error: ' + err.message, false);
  }
}

// Init
f2tPopulateDealSelect();
</script>
</body>
</html>
