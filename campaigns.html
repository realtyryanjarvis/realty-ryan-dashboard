<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Email Campaigns ‚Äî Realty Ryan</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #FFFFFF; font-family: 'Work Sans', sans-serif; color: #1a1a1a; min-height: 100vh; }

.header-compact { background: #F8F6F3; border-bottom: 2px solid #7A3B14; }
.hdr-top { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px 10px; }
.hdr-top h1 { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 300; letter-spacing: 0.12em; text-transform: uppercase; color: #1a1a1a; }
.back-link { font-size: 13px; color: #c97a3b; text-decoration: none; font-weight: 500; }
.back-link:hover { color: #e08a42; }

/* Summary Bar */
.summary-bar { display: flex; justify-content: center; gap: 0; padding: 8px 24px 14px; background: #F8F6F3; }
.sb-item { text-align: center; padding: 0 24px; }
.sb-num { font-family: 'Cormorant Garamond', serif; font-size: 36px; font-weight: 600; color: #1a1a1a; display: block; line-height: 1; }
.sb-num.accent { color: #7A3B14; }
.sb-lbl { font-size: 10px; color: #8a8480; text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; display: block; }
.sb-divider { width: 1px; height: 36px; background: #E8E4DE; align-self: center; }

/* Section */
.section-header { padding: 16px 24px 8px; display: flex; align-items: center; gap: 12px; }
.section-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 600; color: #1a1a1a; letter-spacing: 0.08em; }
.section-badge { background: #7A3B14; color: #FFFFFF; font-size: 11px; font-weight: 600; padding: 2px 10px; border-radius: 12px; }

/* Campaign Cards */
.campaigns-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; padding: 12px 24px 24px; }
.campaign-card { background: #F8F6F3; border-radius: 8px; border: 1px solid #E1D8CE; overflow: hidden; transition: border-color 0.2s; }
.campaign-card:hover { border-color: #7A3B14; }
.campaign-card-header { padding: 16px; cursor: pointer; }
.campaign-name { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px; }
.campaign-desc { font-size: 11px; color: #8a8480; margin-bottom: 12px; }
.campaign-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.cs-item { text-align: center; }
.cs-val { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 600; color: #c97a3b; }
.cs-label { font-size: 9px; color: #8a8480; text-transform: uppercase; letter-spacing: 0.06em; }
.campaign-last-send { font-size: 10px; color: #E1D8CE; margin-top: 10px; }
.expand-toggle { font-size: 11px; color: #7A3B14; cursor: pointer; margin-top: 8px; user-select: none; }
.expand-toggle:hover { color: #c97a3b; }

/* Expandable Detail */
.campaign-detail { display: none; border-top: 1px solid #E8E4DE; padding: 12px 16px; }
.campaign-detail.open { display: block; }
.email-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #F0EDE8; font-size: 12px; }
.email-row:last-child { border-bottom: none; }
.er-label { color: #1a1a1a; font-weight: 500; }
.er-subject { color: #8a8480; font-size: 11px; margin-left: 8px; }
.er-stats { display: flex; gap: 16px; color: #8a8480; font-size: 11px; }
.er-stat-val { color: #c97a3b; font-weight: 600; }

/* Activity Feed */
.activity-feed { padding: 0 24px 24px; }
.activity-table { width: 100%; border-collapse: collapse; }
.activity-table th { font-size: 10px; color: #8a8480; text-transform: uppercase; letter-spacing: 0.08em; padding: 8px 12px; text-align: left; border-bottom: 1px solid #E1D8CE; }
.activity-table td { font-size: 12px; padding: 10px 12px; border-bottom: 1px solid #F0EDE8; color: #1a1a1a; }
.activity-table tr:hover td { background: rgba(122,59,20,0.1); }
.td-muted { color: #8a8480; }
.td-campaign { color: #c97a3b; font-weight: 500; }

.loading { text-align: center; padding: 40px; color: #8a8480; font-size: 14px; }
.footer { padding: 16px 24px; text-align: center; font-size: 11px; color: #E1D8CE; }

@media (max-width: 768px) {
  .campaigns-grid { grid-template-columns: 1fr; padding: 8px 16px 16px; }
  .summary-bar { flex-wrap: wrap; gap: 4px; padding: 4px 16px 12px; }
  .sb-item { padding: 0 14px; }
  .sb-num { font-size: 28px; }
  .sb-divider { height: 28px; }
  .hdr-top { flex-direction: column; gap: 8px; padding: 12px 16px 8px; }
  .campaign-stats { grid-template-columns: repeat(2, 1fr); }
  .activity-feed { padding: 0 16px 16px; overflow-x: auto; }
}
@media (max-width: 480px) {
  .hdr-top h1 { font-size: 18px; }
  .sb-num { font-size: 22px; }
  .sb-divider { display: none; }
}
</style>
</head>
<body>

<div class="header-compact">
  <div class="hdr-top">
    <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
    <h1>üìß Email Campaigns</h1>
    <span></span>
  </div>
  <div class="summary-bar" id="summaryBar">
    <div class="sb-item"><span class="sb-num" id="totalSent">‚Äî</span><span class="sb-lbl">Total Sent</span></div>
    <div class="sb-divider"></div>
    <div class="sb-item"><span class="sb-num" id="totalRecipients">‚Äî</span><span class="sb-lbl">Recipients</span></div>
    <div class="sb-divider"></div>
    <div class="sb-item"><span class="sb-num accent" id="totalOpens">‚Äî</span><span class="sb-lbl">Opens</span></div>
    <div class="sb-divider"></div>
    <div class="sb-item"><span class="sb-num accent" id="avgOpenRate">‚Äî</span><span class="sb-lbl">Open Rate</span></div>
  </div>
</div>

<div class="section-header">
  <h2>Campaigns</h2>
  <span class="section-badge" id="campaignCount">5</span>
</div>
<div class="campaigns-grid" id="campaignsGrid">
  <div class="loading">Loading campaigns‚Ä¶</div>
</div>

<div class="section-header">
  <h2>Recent Activity</h2>
  <span class="section-badge" id="activityCount">0</span>
</div>
<div class="activity-feed">
  <table class="activity-table" id="activityTable">
    <thead>
      <tr><th>Time</th><th>Recipient</th><th>Campaign</th><th>Day</th><th>Subject</th><th>Opened</th></tr>
    </thead>
    <tbody id="activityBody">
      <tr><td colspan="6" class="loading">Loading‚Ä¶</td></tr>
    </tbody>
  </table>
</div>

<div class="footer">Realty Ryan ‚Äî Email Campaign Tracker</div>

<script>
const FB = 'https://realtyryan-dashboard-default-rtdb.firebaseio.com/realty-ryan/email_tracking';

const CAMPAIGNS = {
  'meet-ryan': { name: 'Meet Ryan 7-Day Drip', desc: '7 emails, days 0‚Äì6', days: 7 },
  'open-house': { name: 'Open House 5-Email Drip', desc: '5 emails post-open house', days: 5 },
  'relocating-charlotte': { name: 'Relocating to Charlotte Series', desc: 'Days 0‚Äì60 relocation drip', days: 61 },
  'weekly-newsletter': { name: 'The Charlotte Rundown', desc: 'Weekly newsletter', days: null },
  'neighborhood-reports': { name: 'Neighborhood Market Reports', desc: 'Monthly market reports', days: null }
};

async function fetchJSON(url) {
  const r = await fetch(url);
  if (!r.ok) return null;
  return r.json();
}

function timeAgo(ts) {
  const d = new Date(ts);
  const now = new Date();
  const diff = Math.floor((now - d) / 1000);
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff/60) + 'm ago';
  if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatDate(ts) {
  if (!ts) return '‚Äî';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

async function load() {
  const [sendsData, opensData] = await Promise.all([
    fetchJSON(FB + '/sends.json'),
    fetchJSON(FB + '/opens.json')
  ]);

  const sends = sendsData || {};
  const opens = opensData || {};

  // Aggregate per campaign
  const campStats = {};
  const allSends = [];

  for (const [id, s] of Object.entries(sends)) {
    const key = s.campaign || 'unknown';
    if (!campStats[key]) campStats[key] = { sent: 0, recipients: new Set(), opens: 0, lastSend: null, emails: {} };
    const cs = campStats[key];
    cs.sent++;
    if (s.email) cs.recipients.add(s.email);
    const openInfo = opens[id];
    const openCount = openInfo ? (openInfo.count || 1) : 0;
    cs.opens += openCount;
    if (!cs.lastSend || new Date(s.sentAt) > new Date(cs.lastSend)) cs.lastSend = s.sentAt;

    const dayKey = s.day != null ? s.day : 'all';
    if (!cs.emails[dayKey]) cs.emails[dayKey] = { sent: 0, opens: 0, subject: s.subject || '' };
    cs.emails[dayKey].sent++;
    cs.emails[dayKey].opens += openCount;

    allSends.push({ id, ...s, opened: openCount > 0, openCount });
  }

  // Summary
  const totalSent = Object.values(sends).length;
  const allEmails = new Set(Object.values(sends).map(s => s.email).filter(Boolean));
  const totalOpens = Object.values(opens).reduce((sum, o) => sum + (o.count || 1), 0);
  const openRate = totalSent ? Math.round((Object.keys(opens).length / totalSent) * 100) : 0;

  document.getElementById('totalSent').textContent = totalSent;
  document.getElementById('totalRecipients').textContent = allEmails.size;
  document.getElementById('totalOpens').textContent = totalOpens;
  document.getElementById('avgOpenRate').textContent = openRate + '%';

  // Render campaign cards
  const grid = document.getElementById('campaignsGrid');
  grid.innerHTML = '';

  for (const [key, meta] of Object.entries(CAMPAIGNS)) {
    const stats = campStats[key] || { sent: 0, recipients: new Set(), opens: 0, lastSend: null, emails: {} };
    const rate = stats.sent ? Math.round((stats.opens / stats.sent) * 100) : 0;

    const card = document.createElement('div');
    card.className = 'campaign-card';
    card.innerHTML = `
      <div class="campaign-card-header" onclick="this.parentElement.querySelector('.campaign-detail').classList.toggle('open'); this.querySelector('.expand-toggle').textContent = this.parentElement.querySelector('.campaign-detail').classList.contains('open') ? '‚ñ≤ Hide emails' : '‚ñº Show emails';">
        <div class="campaign-name">${meta.name}</div>
        <div class="campaign-desc">${meta.desc}</div>
        <div class="campaign-stats">
          <div class="cs-item"><div class="cs-val">${stats.sent}</div><div class="cs-label">Sent</div></div>
          <div class="cs-item"><div class="cs-val">${stats.recipients.size}</div><div class="cs-label">Recipients</div></div>
          <div class="cs-item"><div class="cs-val">${stats.opens}</div><div class="cs-label">Opens</div></div>
          <div class="cs-item"><div class="cs-val">${rate}%</div><div class="cs-label">Open Rate</div></div>
        </div>
        <div class="campaign-last-send">Last send: ${formatDate(stats.lastSend)}</div>
        <div class="expand-toggle">‚ñº Show emails</div>
      </div>
      <div class="campaign-detail">
        ${Object.entries(stats.emails).sort(([a],[b]) => (a === 'all' ? 999 : +a) - (b === 'all' ? 999 : +b)).map(([day, e]) => `
          <div class="email-row">
            <div><span class="er-label">${day === 'all' ? 'All' : 'Day ' + day}</span><span class="er-subject">${e.subject}</span></div>
            <div class="er-stats"><span>Sent: <span class="er-stat-val">${e.sent}</span></span><span>Opens: <span class="er-stat-val">${e.opens}</span></span></div>
          </div>
        `).join('') || '<div style="color:#8a8480;font-size:12px;padding:8px 0;">No sends yet</div>'}
      </div>
    `;
    grid.appendChild(card);
  }

  // Activity feed
  allSends.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
  const recent = allSends.slice(0, 20);
  const tbody = document.getElementById('activityBody');
  document.getElementById('activityCount').textContent = recent.length;

  if (recent.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="color:#8a8480;text-align:center;padding:20px;">No sends recorded yet</td></tr>';
  } else {
    tbody.innerHTML = recent.map(s => `
      <tr>
        <td class="td-muted">${timeAgo(s.sentAt)}</td>
        <td>${s.recipient || s.email || '‚Äî'}</td>
        <td class="td-campaign">${(CAMPAIGNS[s.campaign] || {}).name || s.campaign}</td>
        <td class="td-muted">${s.day != null ? 'Day ' + s.day : '‚Äî'}</td>
        <td class="td-muted">${s.subject || '‚Äî'}</td>
        <td>${s.opened ? '‚úÖ' : '‚Äî'}</td>
      </tr>
    `).join('');
  }
}

load();
</script>
</body>
</html>
